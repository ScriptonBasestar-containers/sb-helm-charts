# Promtail - Monitoring Stack Example
# Log collection agent (DaemonSet on all nodes)

image:
  repository: grafana/promtail
  pullPolicy: IfNotPresent
  tag: "3.2.1"

promtail:
  # Loki client configuration
  client:
    url: "http://loki.monitoring.svc.cluster.local:3100/loki/api/v1/push"
    batchWait: 1s
    batchSize: 1048576  # 1MB
    timeout: 10s

  # Scrape configurations
  scrapeConfigs:
    # Container logs
    - job_name: kubernetes-pods
      kubernetes_sd_configs:
        - role: pod
      pipeline_stages:
        - cri: {}
      relabel_configs:
        # Add namespace label
        - source_labels:
            - __meta_kubernetes_pod_namespace
          target_label: namespace
        # Add pod name label
        - source_labels:
            - __meta_kubernetes_pod_name
          target_label: pod
        # Add container name label
        - source_labels:
            - __meta_kubernetes_pod_container_name
          target_label: container
        # Add node name label
        - source_labels:
            - __meta_kubernetes_pod_node_name
          target_label: node

  # Pipeline stages for log processing
  pipelineStages:
    # CRI format (containerd/cri-o)
    cri:
      enabled: true

    # Custom stages (optional)
    custom:
      # Parse JSON logs
      - json:
          expressions:
            level: level
            timestamp: timestamp
            message: message
      # Extract log level
      - labels:
          level:

  # Positions file
  positions:
    filename: /tmp/positions.yaml

# DaemonSet configuration
hostNetwork: false
hostPID: false

# Volume mounts for log collection
volumeMounts:
  - name: varlog
    mountPath: /var/log
    readOnly: true
  - name: varlibdockercontainers
    mountPath: /var/lib/docker/containers
    readOnly: true

volumes:
  - name: varlog
    hostPath:
      path: /var/log
  - name: varlibdockercontainers
    hostPath:
      path: /var/lib/docker/containers

# Resources (per node)
resources:
  limits:
    cpu: 500m
    memory: 256Mi
  requests:
    cpu: 100m
    memory: 128Mi

# Service
service:
  type: ClusterIP
  port: 3101

# ServiceMonitor
serviceMonitor:
  enabled: true
  interval: 30s

# Security
serviceAccount:
  create: true

podSecurityContext:
  runAsUser: 0  # Required to read logs
  runAsGroup: 0
  fsGroup: 0

securityContext:
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: true
  allowPrivilegeEscalation: false

# Update strategy
updateStrategy:
  type: RollingUpdate
  rollingUpdate:
    maxUnavailable: 1

# Tolerations - run on all nodes
tolerations:
  - operator: Exists
    effect: NoSchedule
  - operator: Exists
    effect: NoExecute

# RBAC for Kubernetes SD
rbac:
  create: true
  clusterRole:
    create: true
