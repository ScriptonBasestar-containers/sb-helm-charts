# Example production values for thanos-ruler

replicaCount: 2

objstore:
  type: "s3"
  s3:
    endpoint: "minio.storage.svc.cluster.local:9000"
    bucket: "thanos"
    region: "us-east-1"
    accessKey: ""     # Set via --set or external secret
    secretKey: ""     # Set via --set or external secret
    insecure: true    # Set false for TLS

thanos:
  ruler:
    # Connect to Thanos Query for rule evaluation
    queryEndpoints:
      - dnssrv+_grpc._tcp.thanos-query.monitoring.svc.cluster.local

    # Send alerts to Alertmanager
    alertmanagers:
      - http://alertmanager.monitoring.svc.cluster.local:9093

    # Rule evaluation settings
    evaluationInterval: "30s"

    # Labels added to all alerts/rules
    labels:
      ruler_cluster: "production"

    # Drop these labels from alerts (useful for deduplication)
    alertLabelDrop:
      - prometheus_replica
      - ruler_replica

  telemetry:
    logLevel: "info"

# Recording and alerting rules
rules:
  # Recording rules for precomputing expensive queries
  recording-rules.yaml: |
    groups:
      - name: cpu_memory_rules
        interval: 30s
        rules:
          - record: job:process_cpu_seconds_total:rate5m
            expr: sum(rate(process_cpu_seconds_total[5m])) by (job)
          - record: job:process_resident_memory_bytes:avg
            expr: avg(process_resident_memory_bytes) by (job)

      - name: http_rules
        interval: 30s
        rules:
          - record: job:http_requests_total:rate5m
            expr: sum(rate(http_requests_total[5m])) by (job)
          - record: job:http_request_duration_seconds:p99
            expr: histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket[5m])) by (job, le))

  # Alerting rules
  alerting-rules.yaml: |
    groups:
      - name: availability_alerts
        rules:
          - alert: HighErrorRate
            expr: |
              sum(rate(http_requests_total{status=~"5.."}[5m])) by (job)
              /
              sum(rate(http_requests_total[5m])) by (job)
              > 0.05
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "High error rate detected for {{ $labels.job }}"
              description: "Error rate is {{ $value | humanizePercentage }}"

          - alert: HighLatency
            expr: job:http_request_duration_seconds:p99 > 1
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: "High latency for {{ $labels.job }}"
              description: "P99 latency is {{ $value }}s"

      - name: resource_alerts
        rules:
          - alert: HighMemoryUsage
            expr: |
              (process_resident_memory_bytes / on(instance) machine_memory_bytes) > 0.9
            for: 15m
            labels:
              severity: warning
            annotations:
              summary: "High memory usage on {{ $labels.instance }}"

          - alert: HighCPUUsage
            expr: rate(process_cpu_seconds_total[5m]) > 0.9
            for: 15m
            labels:
              severity: warning
            annotations:
              summary: "High CPU usage for {{ $labels.job }}"

persistence:
  enabled: true
  size: 20Gi
  storageClass: ""

resources:
  limits:
    cpu: 2000m
    memory: 2Gi
  requests:
    cpu: 500m
    memory: 512Mi

podDisruptionBudget:
  enabled: true
  minAvailable: 1

serviceMonitor:
  enabled: true
  interval: "30s"

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: thanos-ruler
          topologyKey: kubernetes.io/hostname
