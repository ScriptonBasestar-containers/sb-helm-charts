# Default values for tempo

# Number of Tempo instances
replicaCount: 1

image:
  repository: grafana/tempo
  pullPolicy: IfNotPresent
  # Overrides the image tag whose default is the chart appVersion
  tag: ""

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

# Tempo configuration
tempo:
  # Use an existing ConfigMap for Tempo configuration
  existingConfigMap: ""

  # Use an existing Secret for S3 credentials
  existingSecret: ""

  # Authentication configuration
  auth:
    enabled: false

  # Storage configuration
  storage:
    # Storage type: local or s3
    type: "local"

    # Local storage configuration
    local:
      path: "/var/tempo/traces"

    # S3/MinIO storage configuration (only used if type is "s3")
    s3:
      endpoint: ""  # e.g., minio.default.svc.cluster.local:9000
      bucket: "tempo-traces"
      accessKeyId: ""
      secretAccessKey: ""
      insecure: false  # Set true for HTTP (MinIO dev)

  # Trace retention
  retention:
    # Number of days to retain traces
    days: 7

  # Receiver configurations
  receivers:
    otlp:
      grpc:
        enabled: true
        port: 4317
      http:
        enabled: true
        port: 4318
    jaeger:
      grpc:
        enabled: false
        port: 14250
      thriftHttp:
        enabled: false
        port: 14268
    zipkin:
      enabled: false
      port: 9411

  # Distributor configuration
  distributor:
    receivers: []
      # - otlp

  # Ingester configuration
  ingester:
    # Trace idle time before flushing
    traceIdleTime: "10s"
    # Maximum block duration
    maxBlockDuration: "30m"

  # Compactor configuration
  compactor:
    # Compaction window
    compactionWindow: "1h"
    # Number of compaction cycles
    maxCompactionObjects: 1000000

  # Query frontend configuration
  queryFrontend:
    # Search configuration
    search:
      enabled: true
      maxDuration: "0"

  # Additional Tempo configuration
  # This will be merged with the generated config
  config: {}

  # Extra environment variables
  extraEnv: []
  # - name: CUSTOM_VAR
  #   value: "custom_value"

serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

# RBAC Configuration
rbac:
  # Specifies whether RBAC resources should be created
  create: true
  # Annotations to add to the Role and RoleBinding
  annotations: {}

podAnnotations: {}

podSecurityContext:
  fsGroup: 10001
  runAsUser: 10001
  runAsNonRoot: true

securityContext:
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: false  # Tempo requires writable filesystem
  runAsNonRoot: true
  runAsUser: 10001

service:
  type: ClusterIP
  # HTTP API port
  port: 3200
  annotations: {}
  # Additional ports for receivers
  ports:
    otlpGrpc: 4317
    otlpHttp: 4318
    jaegerGrpc: 14250
    jaegerThriftHttp: 14268
    zipkin: 9411

resources:
  limits:
    cpu: 1000m
    memory: 2Gi
  requests:
    cpu: 100m
    memory: 256Mi

livenessProbe:
  httpGet:
    path: /ready
    port: 3200
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /ready
    port: 3200
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

# Persistence configuration (only used if storage.type is "local")
persistence:
  enabled: true
  # storageClass: "-"
  annotations: {}
  accessMode: ReadWriteOnce
  size: 10Gi

nodeSelector: {}

tolerations: []

affinity: {}

# HorizontalPodAutoscaler
autoscaling:
  enabled: false
  minReplicas: 2
  maxReplicas: 5
  targetCPUUtilizationPercentage: 75
  targetMemoryUtilizationPercentage: 80

# PodDisruptionBudget
podDisruptionBudget:
  enabled: false
  minAvailable: 1
  # maxUnavailable: 1

# ServiceMonitor (Prometheus Operator)
serviceMonitor:
  enabled: false
  interval: 30s
  scrapeTimeout: 10s
  path: /metrics
  labels: {}
  relabelings: []
  metricRelabelings: []

# NetworkPolicy
networkPolicy:
  enabled: false
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 3200
        - protocol: TCP
          port: 4317
        - protocol: TCP
          port: 4318
  egress:
    # Allow DNS
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: UDP
          port: 53
    # Allow S3/MinIO
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 9000
        - protocol: TCP
          port: 443

# =============================================================================
# Backup & Recovery Configuration
# =============================================================================
# Note: Backup is handled via Makefile targets, not automated CronJobs
# See: docs/tempo-backup-guide.md for detailed procedures
backup:
  enabled: false  # Documentation only - no CronJob created
  documentation:
    strategy: "config + trace_data + wal + pvc_snapshots (local) OR config + s3_versioning (S3)"
    tools:
      - "kubectl (for data extraction)"
      - "tar/gzip (for compression)"
      - "aws-cli or mc (for S3 upload)"
      - "VolumeSnapshot API (for PVC snapshots)"
    components:
      configuration:
        description: "ConfigMap and Secrets (S3 credentials)"
        method: "ConfigMap export + Secret export"
        frequency: "Daily or before changes"
        retention: "90 days"
        size: "< 100KB"
      trace_data:
        description: "Compressed trace blocks"
        method: "tar + kubectl cp (local) OR S3 versioning (S3)"
        frequency: "Daily (local) / Continuous (S3)"
        retention: "30 days (local) / 90-365 days (S3)"
        size: "Varies by trace volume (typically 10-100 GB)"
      wal:
        description: "Write-Ahead Log (recent traces)"
        method: "Flush + tar + kubectl cp"
        frequency: "Hourly (recent traces only)"
        retention: "7 days"
        size: "100 MB - 10 GB"
      pvc_snapshots:
        description: "Complete persistent volume snapshot (local mode only)"
        method: "Kubernetes VolumeSnapshot API"
        frequency: "Weekly"
        retention: "7-14 days"
        size: "Same as PVC size (typically 10-100 GB)"
    targets:
      rto: "< 2 hours (local) / < 30 minutes (S3)"
      rpo: "24 hours (local) / 1 hour (S3 with hourly snapshots)"
    commands:
      backup:
        full: "make -f make/ops/tempo.mk tempo-backup-all"
        config: "make -f make/ops/tempo.mk tempo-backup-config"
        data: "make -f make/ops/tempo.mk tempo-backup-data"
        wal: "make -f make/ops/tempo.mk tempo-backup-wal"
        pvc: "make -f make/ops/tempo.mk tempo-backup-pvc-snapshot"
        verify: "make -f make/ops/tempo.mk tempo-backup-verify BACKUP_FILE=<path>"
      restore:
        full: "make -f make/ops/tempo.mk tempo-restore-all BACKUP_FILE=<path>"
        config: "make -f make/ops/tempo.mk tempo-restore-config BACKUP_FILE=<path>"
        data: "make -f make/ops/tempo.mk tempo-restore-data BACKUP_FILE=<path>"

# =============================================================================
# Upgrade Configuration
# =============================================================================
# Note: Upgrades are performed manually via Helm, not automated
# See: docs/tempo-upgrade-guide.md for detailed procedures
upgrade:
  enabled: false  # Documentation only - manual process
  preUpgradeBackup: true  # Always backup before upgrade
  documentation:
    strategies:
      rolling:
        description: "StatefulSet/Deployment rolling update with zero downtime"
        downtime: "None (with HA, replicas >= 2, S3 storage)"
        complexity: "Low"
        recommended: true
        steps:
          - "Pre-upgrade validation (12 checks)"
          - "Create backup"
          - "Flush WAL to storage"
          - "Helm upgrade with new image tag"
          - "Post-upgrade validation (10 checks)"
      blue_green:
        description: "Deploy new cluster in parallel, cutover when ready"
        downtime: "10-20 minutes (during cutover)"
        complexity: "Medium"
        recommended: false
        steps:
          - "Deploy new Tempo cluster (different namespace)"
          - "Configure dual-write from applications"
          - "Validate new cluster"
          - "Update Grafana datasource to new cluster"
          - "Decommission old cluster"
      maintenance:
        description: "Full cluster stop, upgrade, restart"
        downtime: "15-20 minutes"
        complexity: "Low"
        recommended: false
        steps:
          - "Create backup"
          - "Scale down to 0 replicas"
          - "Helm upgrade"
          - "Scale up replicas"
          - "Validate"
    version_notes:
      tempo_2_7_to_2_8:
        breaking_changes: []
        notable_changes:
          - "WAL format improvements (automatic migration)"
          - "Distributor configuration enhancements"
        recommended_steps:
          - "Backup before upgrade"
          - "Flush WAL before upgrade"
          - "Rolling upgrade recommended"
      tempo_2_8_to_2_9:
        breaking_changes: []
        notable_changes:
          - "TraceQL query enhancements"
          - "vParquet4 block format (automatic)"
          - "Query frontend performance improvements"
        recommended_steps:
          - "Backup before upgrade"
          - "Rolling upgrade recommended"
      chart_0_2_to_0_3:
        breaking_changes: []
        notable_changes:
          - "RBAC templates added (rbac.create: true by default)"
          - "Backup/upgrade Makefile targets"
          - "Enhanced operations documentation"
        recommended_steps:
          - "Review RBAC configuration"
          - "Test Makefile targets"
    commands:
      pre_upgrade:
        check: "make -f make/ops/tempo.mk tempo-pre-upgrade-check"
        backup: "make -f make/ops/tempo.mk tempo-backup-all"
        flush_wal: "make -f make/ops/tempo.mk tempo-flush-wal"
      post_upgrade:
        check: "make -f make/ops/tempo.mk tempo-post-upgrade-check"
        validate: "make -f make/ops/tempo.mk tempo-test-trace"
      rollback:
        helm: "helm rollback tempo"
        restore: "make -f make/ops/tempo.mk tempo-restore-all BACKUP_FILE=<path>"
