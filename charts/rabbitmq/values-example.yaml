# Production-ready example configuration for RabbitMQ
# Copy this file and customize for your environment

# ==============================================================================
# Example 1: Basic Production Deployment
# ==============================================================================
# Minimal production setup with strong security and persistence

rabbitmq:
  admin:
    username: "admin"
    # CRITICAL: Change password for production
    # Generate with: openssl rand -base64 32
    password: "CHANGE_ME_STRONG_PASSWORD"

persistence:
  enabled: true
  storageClass: ""  # Use default StorageClass
  size: 20Gi
  reclaimPolicy: Retain  # Prevent accidental data loss

resources:
  limits:
    cpu: 2000m
    memory: 2Gi
  requests:
    cpu: 500m
    memory: 1Gi

monitoring:
  enabled: true
  serviceMonitor:
    enabled: true
    interval: 30s
    scrapeTimeout: 10s
    labels:
      prometheus: kube-prometheus

---
# ==============================================================================
# Example 2: Production-Tuned Configuration
# ==============================================================================
# Advanced RabbitMQ settings for high-performance production

rabbitmq:
  admin:
    username: "admin"
    password: "CHANGE_ME_STRONG_PASSWORD"

  conf: |
    ## Network
    listeners.tcp.default = 5672

    ## Management UI
    management.tcp.port = 15672
    management.tcp.ip = 0.0.0.0

    ## Memory threshold (70% for production)
    vm_memory_high_watermark.relative = 0.7
    vm_memory_high_watermark_paging_ratio = 0.75

    ## Disk space limit (5GB minimum)
    disk_free_limit.absolute = 5GB

    ## Connection limits
    channel_max = 2048

    ## Default vhost
    default_vhost = /production
    default_user = admin
    default_pass = CHANGE_ME_STRONG_PASSWORD
    default_permissions.configure = .*
    default_permissions.read = .*
    default_permissions.write = .*

    ## Logging (warning level for production)
    log.console = true
    log.console.level = warning
    log.file = false

    ## Queue settings
    queue_master_locator = min-masters

    ## Cluster partition handling
    cluster_partition_handling = autoheal

    ## Consumer timeout (30 minutes)
    consumer_timeout = 1800000

    ## Heartbeat
    heartbeat = 60

  plugins: |
    [rabbitmq_management,rabbitmq_management_agent,rabbitmq_prometheus,rabbitmq_shovel,rabbitmq_shovel_management].

persistence:
  enabled: true
  size: 50Gi
  reclaimPolicy: Retain

resources:
  limits:
    cpu: 4000m
    memory: 4Gi
  requests:
    cpu: 1000m
    memory: 2Gi

---
# ==============================================================================
# Example 3: Ingress with TLS
# ==============================================================================
# Expose management UI via HTTPS

ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/whitelist-source-range: "10.0.0.0/8"
  hosts:
    - host: rabbitmq.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: rabbitmq-tls
      hosts:
        - rabbitmq.example.com

---
# ==============================================================================
# Example 4: NodePort Service (Bare-Metal/K3s)
# ==============================================================================

service:
  type: NodePort
  amqp:
    port: 5672
    nodePort: 30672
  management:
    port: 15672
    nodePort: 30673
  metrics:
    port: 15692

---
# ==============================================================================
# Example 5: Network Policy Enabled
# ==============================================================================

networkPolicy:
  enabled: true
  ingress:
    - from:
      - namespaceSelector:
          matchLabels:
            name: production
      - podSelector:
          matchLabels:
            app: myapp
      ports:
        - protocol: TCP
          port: 5672
        - protocol: TCP
          port: 15672

---
# ==============================================================================
# Example 6: Using Existing Secret
# ==============================================================================

rabbitmq:
  admin:
    existingSecret:
      enabled: true
      secretName: "rabbitmq-admin-secret"
      usernameKey: "username"
      passwordKey: "password"

# Create secret separately:
# kubectl create secret generic rabbitmq-admin-secret \
#   --from-literal=username=admin \
#   --from-literal=password=YOUR_PASSWORD

---
# ==============================================================================
# Example 7: Home Server / Resource-Constrained
# ==============================================================================

resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 256Mi

persistence:
  enabled: true
  size: 5Gi

rabbitmq:
  conf: |
    listeners.tcp.default = 5672
    management.tcp.port = 15672
    vm_memory_high_watermark.relative = 0.5
    disk_free_limit.absolute = 1GB
    log.console = true
    log.console.level = info

---
# ==============================================================================
# Example 8: Complete Production Setup
# ==============================================================================

rabbitmq:
  admin:
    username: "admin"
    password: "CHANGE_ME_STRONG_PASSWORD"
  conf: |
    listeners.tcp.default = 5672
    management.tcp.port = 15672
    vm_memory_high_watermark.relative = 0.7
    disk_free_limit.absolute = 5GB
    channel_max = 2048
    log.console = true
    log.console.level = warning
    queue_master_locator = min-masters
    cluster_partition_handling = autoheal
  plugins: |
    [rabbitmq_management,rabbitmq_management_agent,rabbitmq_prometheus,rabbitmq_shovel,rabbitmq_shovel_management].

persistence:
  enabled: true
  storageClass: "fast-ssd"
  size: 50Gi
  reclaimPolicy: Retain

strategy:
  type: RollingUpdate
  rollingUpdate:
    maxUnavailable: 0
    maxSurge: 1

resources:
  limits:
    cpu: 4000m
    memory: 4Gi
  requests:
    cpu: 1000m
    memory: 2Gi

ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
  hosts:
    - host: rabbitmq.internal.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: rabbitmq-tls
      hosts:
        - rabbitmq.internal.example.com

podDisruptionBudget:
  enabled: true
  minAvailable: 1

networkPolicy:
  enabled: true
  ingress:
    - from:
      - namespaceSelector:
          matchLabels:
            name: production
      ports:
        - protocol: TCP
          port: 5672

monitoring:
  enabled: true
  serviceMonitor:
    enabled: true
    namespace: "monitoring"
    interval: 15s
    scrapeTimeout: 10s
    labels:
      prometheus: kube-prometheus

nodeSelector:
  node-role.kubernetes.io/worker: "true"

priorityClassName: "high-priority"
