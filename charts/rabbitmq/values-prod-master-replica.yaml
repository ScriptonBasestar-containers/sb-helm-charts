# Production scenario for rabbitmq - Single Instance
# Full monitoring, network policies, and production-grade configuration
#
# ⚠️ IMPORTANT: RabbitMQ Clustering Clarification
#
# Despite the filename "prod-master-replica", this chart deploys a SINGLE RabbitMQ instance.
# RabbitMQ clustering is NOT implemented in the current chart templates.
#
# This deployment:
#   - Creates ONE RabbitMQ instance (not clustered)
#   - Suitable for: Development, Testing, Low-volume production workloads
#   - NOT suitable for: High-availability production requiring automatic failover
#
# For production RabbitMQ clustering with high availability:
#
# Option 1: RabbitMQ Cluster Operator (Recommended)
#   - Official operator from RabbitMQ team
#   - GitHub: https://github.com/rabbitmq/cluster-operator
#   - Features: Automatic cluster formation, rolling upgrades, backup/restore
#   - Installation:
#       kubectl apply -f https://github.com/rabbitmq/cluster-operator/releases/latest/download/cluster-operator.yml
#
# Option 2: Bitnami RabbitMQ Helm Chart
#   - Full clustering support out of the box
#   - GitHub: https://github.com/bitnami/charts/tree/main/bitnami/rabbitmq
#   - Installation:
#       helm repo add bitnami https://charts.bitnami.com/bitnami
#       helm install rabbitmq bitnami/rabbitmq --set replicaCount=3
#
# Migration Path:
#   1. Use this chart for development/testing
#   2. Test your application thoroughly with single instance
#   3. For production HA: Migrate to RabbitMQ Cluster Operator or Bitnami chart
#   4. See CLAUDE.md for more details on production deployment strategies

# 1. Application-specific Configuration

rabbitmq:
  admin:
    username: "admin"
    # REQUIRED: Set strong admin password via --set rabbitmq.admin.password=xxx
    password: ""

  conf: |
    ## Network configuration
    listeners.tcp.default = 5672

    ## Management plugin
    management.tcp.port = 15672
    management.tcp.ip = 0.0.0.0

    ## Memory threshold (production: 60%)
    vm_memory_high_watermark.relative = 0.6

    ## Disk free space limit (production: higher threshold)
    disk_free_limit.absolute = 5GB

    ## Default vhost
    default_vhost = /

    ## Logging (production level)
    log.console = true
    log.console.level = warning
    log.file = false

    ## Queue master locator
    queue_master_locator = min-masters

    ## Heartbeat
    heartbeat = 60

    ## Cluster partition handling
    cluster_partition_handling = autoheal

    ## Connection limits
    total_memory_available_override_value = 2147483648

  plugins: |
    [rabbitmq_management,rabbitmq_management_agent,rabbitmq_prometheus].

# 3. Persistence Configuration

persistence:
  enabled: true
  storageClass: ""
  accessMode: ReadWriteOnce
  size: 20Gi
  reclaimPolicy: Retain

# 4. Kubernetes Resources

replicaCount: 1

image:
  repository: rabbitmq
  tag: "3.13.1-management"
  pullPolicy: IfNotPresent

strategy:
  type: RollingUpdate
  rollingUpdate:
    maxUnavailable: 0

# 5. Service Account

serviceAccount:
  create: true
  automount: true

# 6. Pod Configuration

podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "15692"

podSecurityContext:
  fsGroup: 999
  runAsUser: 999
  runAsGroup: 999
  runAsNonRoot: true

securityContext:
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: false
  runAsNonRoot: true
  runAsUser: 999
  runAsGroup: 999
  allowPrivilegeEscalation: false

# 7. Service Configuration

service:
  type: ClusterIP
  amqp:
    port: 5672
  management:
    port: 15672
  metrics:
    port: 15692

# 9. Resources - Production grade

resources:
  limits:
    cpu: 2000m
    memory: 2Gi
  requests:
    cpu: 500m
    memory: 1Gi

# 10. Health Probes - Production timeouts

livenessProbe:
  enabled: true
  exec:
    command:
      - rabbitmq-diagnostics
      - ping
  initialDelaySeconds: 60
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 6
  successThreshold: 1

readinessProbe:
  enabled: true
  exec:
    command:
      - rabbitmq-diagnostics
      - check_running
  initialDelaySeconds: 20
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3
  successThreshold: 1

startupProbe:
  enabled: true
  exec:
    command:
      - rabbitmq-diagnostics
      - ping
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 5
  failureThreshold: 60
  successThreshold: 1

# 11. Autoscaling - Disabled (clustering not yet implemented)

autoscaling:
  enabled: false

# 12. Pod Disruption Budget - Enabled

podDisruptionBudget:
  enabled: true
  minAvailable: 1

# 13. Network Policy - Enabled

networkPolicy:
  enabled: true
  ingress:
    # Allow from application pods
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: myapp
      ports:
        - protocol: TCP
          port: 5672
    # Allow from management UI
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: myapp
      ports:
        - protocol: TCP
          port: 15672
    # Allow from monitoring
    - from:
        - namespaceSelector:
            matchLabels:
              name: monitoring
      ports:
        - protocol: TCP
          port: 15692
  egress:
    # Allow DNS
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: UDP
          port: 53

# 14. Monitoring - Full production monitoring

monitoring:
  enabled: true
  serviceMonitor:
    # Enable if Prometheus Operator is installed
    enabled: false
    interval: 30s
    scrapeTimeout: 10s

# 15. Scheduling

nodeSelector: {}
tolerations: []
affinity: {}
