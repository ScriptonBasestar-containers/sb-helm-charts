# Default values for keycloak.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# Keycloak configuration
keycloak:
  # Admin user configuration
  admin:
    username: "admin"
    password: ""  # Required: Set a strong password (deployment will fail if empty)
    # Use existing secret (optional)
    existingSecret:
      enabled: false
      secretName: ""
      usernameKey: "username"
      passwordKey: "password"

  # Keycloak startup arguments
  args:
    - "start"
    - "--optimized"
    # Add --import-realm to import realms from /opt/keycloak/data/import
    # - "--import-realm"

  # Realm import configuration
  realmImport:
    enabled: false
    # ConfigMap name containing realm JSON files
    configMapName: ""
    # Alternatively, use existingVolume
    existingVolume:
      enabled: false
      volumeName: ""

  # Extensions (providers) installation
  extensions:
    enabled: false
    # List of extension JAR files to download
    downloads: []
    # Example:
    # - url: "https://github.com/aerogear/keycloak-metrics-spi/releases/download/2.5.3/keycloak-metrics-spi-2.5.3.jar"
    #   sha256: ""  # Optional checksum verification
    # - url: "https://github.com/wadahiro/keycloak-discord/releases/download/v0.4.0/keycloak-discord-0.4.0.jar"

    # Run kc.sh build after downloading extensions (optional optimization)
    rebuild: false

    # InitContainer image for downloading extensions
    initImage:
      repository: curlimages/curl
      tag: "8.5.0"
      pullPolicy: IfNotPresent

  # Proxy configuration
  proxy:
    # Options: edge, reencrypt, passthrough, none
    mode: "edge"

  # Hostname configuration (v2)
  # Note: Hostname v1 was removed in Keycloak 26.x
  hostname:
    # KC_HOSTNAME - Full URL or domain name for the Keycloak server
    # Example: "keycloak.example.com" or "https://keycloak.example.com"
    hostname: ""
    # KC_HOSTNAME_ADMIN - Admin console URL (if different from hostname)
    # Example: "admin.keycloak.example.com"
    hostnameAdmin: ""
    # KC_HOSTNAME_STRICT - Enable strict hostname checking
    hostnameStrict: false
    # KC_HOSTNAME_BACKCHANNEL_DYNAMIC - Allow dynamic backchannel URLs
    hostnameBackchannelDynamic: false

  # HTTP/HTTPS configuration
  http:
    enabled: true
    port: 8080
  https:
    enabled: false
    port: 8443
    # TLS certificate (use existing secret)
    certificateSecret: ""
    certificateKey: "tls.crt"
    privateKeyKey: "tls.key"

# External PostgreSQL database configuration (required)
postgresql:
  enabled: false  # We use external PostgreSQL
  external:
    enabled: true
    host: ""  # Required: PostgreSQL host (e.g., postgres-service.default.svc.cluster.local)
    port: 5432
    database: "keycloak"
    username: "keycloak"
    password: ""  # Required: Database password (deployment will fail if empty)
    # Use existing secret (optional)
    existingSecret:
      enabled: false
      secretName: ""
      usernameKey: "username"
      passwordKey: "password"
      databaseKey: "database"
    # Connection pool settings
    pool:
      initialSize: 20
      minSize: 20
      maxSize: 100
    # SSL/TLS connection settings
    ssl:
      enabled: false
      # SSL mode: disable, allow, prefer, require, verify-ca, verify-full
      mode: "require"
      # Optional: Path to SSL certificates (mounted from secret)
      certificateSecret: ""
      rootCertKey: "ca.crt"
      clientCertKey: "tls.crt"
      clientKeyKey: "tls.key"

# External Redis configuration (optional, for distributed caching)
redis:
  enabled: false  # We use external Redis (optional)
  external:
    enabled: false
    host: ""  # e.g., redis-service.default.svc.cluster.local
    port: 6379
    password: ""
    database: 0
    # Use existing secret (optional)
    existingSecret:
      enabled: false
      secretName: ""
      passwordKey: "password"
    # SSL/TLS connection settings
    ssl:
      enabled: false
      # Optional: Path to SSL certificates (mounted from secret)
      certificateSecret: ""
      caCertKey: "ca.crt"

# Clustering configuration
clustering:
  enabled: false
  # Infinispan cache settings
  cache:
    ownersCount: 2
    # Stack: tcp, udp
    stack: "tcp"
  # Network binding configuration (Keycloak 26.x uses CLI options instead of JGroups env vars)
  network:
    bindAddress: "0.0.0.0"
    bindPort: 7800
    # External address/port for multi-site deployments (optional)
    externalAddress: ""
    externalPort: ""
  # JGroups discovery (for backward compatibility, but prefer CLI options)
  jgroups:
    discoveryProtocol: "dns.DNS_PING"
    # DNS query for discovering cluster members (auto-generated if empty)
    discoveryProperties: ""

# Persistent storage configuration
persistence:
  enabled: true
  # Keycloak data directory (themes, providers, deployments)
  data:
    enabled: true
    storageClass: ""  # Use default storage class if empty
    accessMode: ReadWriteOnce
    size: 2Gi
    existingClaim: ""

# Replica count
replicaCount: 1

# Container image configuration
image:
  repository: quay.io/keycloak/keycloak
  pullPolicy: IfNotPresent
  # Overrides the image tag whose default is the chart appVersion
  tag: "26.0.6"

# Image pull secrets for private registries
imagePullSecrets: []

# Override chart name
nameOverride: ""
fullnameOverride: ""

# Service account configuration
serviceAccount:
  create: true
  automount: true
  annotations: {}
  name: ""

# Pod annotations
podAnnotations: {}

# Pod labels
podLabels: {}

# Pod security context
podSecurityContext:
  fsGroup: 1000

# Container security context
securityContext:
  runAsUser: 1000
  runAsNonRoot: true
  readOnlyRootFilesystem: false
  capabilities:
    drop:
      - ALL

# Service configuration
service:
  type: ClusterIP
  port: 8080
  targetPort: http
  # Additional service annotations
  annotations: {}

# Admin service configuration (optional, for separate admin access)
adminService:
  enabled: false
  type: ClusterIP
  port: 8080
  targetPort: http
  annotations: {}

# Ingress configuration
ingress:
  enabled: false
  className: "nginx"
  annotations:
    nginx.ingress.kubernetes.io/proxy-buffer-size: "128k"
    nginx.ingress.kubernetes.io/proxy-buffers-number: "4"
    nginx.ingress.kubernetes.io/proxy-busy-buffers-size: "256k"
  hosts:
    - host: keycloak.example.local
      paths:
        - path: /
          pathType: Prefix
  tls: []
  # Example TLS configuration:
  # tls:
  #   - secretName: keycloak-tls
  #     hosts:
  #       - keycloak.example.com

# Admin Ingress configuration (optional, separate admin console access)
adminIngress:
  enabled: false
  className: "nginx"
  annotations:
    nginx.ingress.kubernetes.io/proxy-buffer-size: "128k"
  hosts:
    - host: keycloak-admin.example.local
      paths:
        - path: /admin
          pathType: Prefix
  tls: []

# Resource limits and requests
resources:
  limits:
    cpu: 2000m
    memory: 2Gi
  requests:
    cpu: 500m
    memory: 1Gi

# Liveness probe configuration
livenessProbe:
  httpGet:
    path: /health/live
    port: http
    scheme: HTTP
  initialDelaySeconds: 120
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 6
  successThreshold: 1

# Readiness probe configuration
readinessProbe:
  httpGet:
    path: /health/ready
    port: http
    scheme: HTTP
  initialDelaySeconds: 60
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3
  successThreshold: 1

# Startup probe (for slow initialization)
startupProbe:
  httpGet:
    path: /health/started
    port: http
    scheme: HTTP
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 60
  successThreshold: 1

# Autoscaling configuration
autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 5
  targetCPUUtilizationPercentage: 80
  # targetMemoryUtilizationPercentage: 80

# Pod Disruption Budget (for high availability)
podDisruptionBudget:
  enabled: false
  # minAvailable: 1
  maxUnavailable: 1

# Database health check (InitContainer)
dbHealthCheck:
  enabled: true
  image: postgres:16-alpine
  imagePullPolicy: IfNotPresent

# Network Policy
networkPolicy:
  enabled: false
  ingress:
    # Ingress controller namespace selector
    namespaceSelector: {}
    # Example:
    # namespaceSelector:
    #   matchLabels:
    #     name: ingress-nginx
    podSelector: {}
    # Example:
    # podSelector:
    #   matchLabels:
    #     app: nginx-ingress
    extraRules: []
  egress:
    postgresql:
      podSelector: {}
      # Example:
      # podSelector:
      #   matchLabels:
      #     app: postgresql
      namespaceSelector: {}
    redis:
      podSelector: {}
      namespaceSelector: {}
    extraRules: []

# Monitoring configuration
monitoring:
  enabled: false
  # ServiceMonitor for Prometheus Operator
  serviceMonitor:
    enabled: false
    # Scrape interval
    interval: 30s
    # Additional labels for ServiceMonitor
    labels: {}
    # Metrics path
    path: /metrics

# Node selector
nodeSelector: {}

# Tolerations
tolerations: []

# Affinity rules
affinity: {}
# Example anti-affinity for HA:
# affinity:
#   podAntiAffinity:
#     preferredDuringSchedulingIgnoredDuringExecution:
#       - weight: 100
#         podAffinityTerm:
#           labelSelector:
#             matchExpressions:
#               - key: app.kubernetes.io/name
#                 operator: In
#                 values:
#                   - keycloak
#           topologyKey: kubernetes.io/hostname

# Additional environment variables
extraEnv: []
# Example:
# - name: JAVA_OPTS_APPEND
#   value: "-Djava.net.preferIPv4Stack=true"
# - name: KC_LOG_LEVEL
#   value: "INFO"
#
# Advanced: Override auto-generated JDBC URL with custom parameters
# Note: Later-defined env vars override earlier ones, so this will replace KC_DB_URL
# - name: KC_DB_URL
#   value: "jdbc:postgresql://host:5432/db?sslmode=verify-full&sslrootcert=/custom/path/ca.crt&options=-c%20statement_timeout=30000"
# Or use a secret:
# - name: KC_DB_URL
#   valueFrom:
#     secretKeyRef:
#       name: custom-db-config
#       key: jdbc-url

# Additional environment variables from ConfigMap or Secret
extraEnvFrom: []
# Example:
# - configMapRef:
#     name: keycloak-extra-config
# - secretRef:
#     name: keycloak-extra-secrets

# Additional volumes
extraVolumes: []
# Example:
# - name: custom-themes
#   configMap:
#     name: keycloak-themes

# Additional volume mounts
extraVolumeMounts: []
# Example:
# - name: custom-themes
#   mountPath: /opt/keycloak/themes/custom

# Init containers
initContainers: []
# Example:
# - name: theme-provider
#   image: busybox
#   command: ['sh', '-c', 'cp -r /themes/* /opt/keycloak/themes/']
#   volumeMounts:
#     - name: themes
#       mountPath: /opt/keycloak/themes

# Lifecycle hooks
lifecycle: {}
# Example:
# lifecycle:
#   preStop:
#     exec:
#       command: ["/bin/sh", "-c", "sleep 10"]
