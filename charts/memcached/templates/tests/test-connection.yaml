apiVersion: v1
kind: Pod
metadata:
  name: {{ include "memcached.fullname" . }}-test-connection
  labels:
    {{- include "memcached.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
    - name: test
      image: busybox:latest
      command:
        - sh
        - -c
        - |
          echo "Testing Memcached connection..."

          # Test 1: Check if service DNS is resolvable
          nslookup {{ include "memcached.fullname" . }} && echo "✓ Service DNS is resolvable"

          # Test 2: Check if TCP port is accessible
          nc -zv {{ include "memcached.fullname" . }} {{ .Values.service.port }} 2>&1 && echo "✓ Memcached port is accessible"

          # Test 3: Send version command to memcached
          echo "version" | nc {{ include "memcached.fullname" . }} {{ .Values.service.port }} | grep -q "VERSION" && echo "✓ Memcached is responding correctly"

          echo "✓ All connectivity tests passed"
