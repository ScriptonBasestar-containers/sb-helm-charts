# Memcached Helm Chart - Home Server Configuration
#
# Optimized for:
# - Raspberry Pi 4 (2GB+)
# - Intel NUC / Mini PC
# - Small home servers
# - Personal web applications and caching needs
#
# Features:
# - Reduced memory allocation (128MB vs 256MB default)
# - Lower connection limit (256 vs 1024 default)
# - Minimal resource limits for low-power servers
# - Single replica deployment
# - Suitable for small-scale caching (WordPress, web apps, session storage)
#
# Usage:
#   helm install memcached ./charts/memcached \
#     -f charts/memcached/values-homeserver.yaml

# ========================================
# Memcached Configuration
# ========================================

memcached:
  # Memory allocation - reduced for home servers
  maxMemory: 128  # 128MB (vs 256MB default)
  # Sufficient for:
  # - WordPress site caching (50-100MB typical)
  # - Small web application sessions
  # - API response caching

  # Connection limit - reduced for home use
  maxConnections: 256  # 256 connections (vs 1024 default)
  # Suitable for:
  # - 1-5 concurrent web applications
  # - Low-traffic personal websites
  # - Development/testing environments

  # Chunk size growth factor
  chunkSizeGrowthFactor: 1.25  # Default, works well for mixed workloads

  # Minimum item size
  minItemSize: 48  # Default

  # CAS operations - keep enabled for data consistency
  enableCas: true

  # Logging - minimal for home servers
  verbosity: 0  # 0=silent, 1=errors, 2=warnings, 3=debug

  # Additional optimizations for home servers
  extraArgs:
    - "-o"
    - "modern"  # Use modern memory allocator for better efficiency
    # Other useful options:
    # - "-o hashpower=16"  # Smaller hash table for low memory (2^16 vs 2^18 default)
    # - "-o tail_repair_time=0"  # Disable tail repair for slight performance boost

# ========================================
# Persistence
# ========================================

# Memcached is in-memory only (no persistence needed)
persistence:
  enabled: false

# ========================================
# Kubernetes Resources
# ========================================

# Single replica for home servers
replicaCount: 1

image:
  repository: memcached
  pullPolicy: IfNotPresent
  tag: "1.6.39-alpine3.22"  # Alpine for minimal footprint

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

# Deployment strategy
strategy:
  type: RollingUpdate
  rollingUpdate:
    maxUnavailable: 0
    maxSurge: 1

# ========================================
# Service Account
# ========================================

serviceAccount:
  create: true
  automount: true
  annotations: {}
  name: ""

# ========================================
# Pod Configuration
# ========================================

podAnnotations: {}
podLabels: {}

# Security context
podSecurityContext:
  fsGroup: 11211
  runAsUser: 11211
  runAsGroup: 11211
  runAsNonRoot: true

securityContext:
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 11211
  runAsGroup: 11211
  allowPrivilegeEscalation: false

# ========================================
# Service Configuration
# ========================================

service:
  type: ClusterIP
  port: 11211
  annotations: {}

# Ingress not applicable for Memcached (binary protocol)
ingress:
  enabled: false

# ========================================
# Resource Limits
# ========================================

# Very lightweight resources for home servers
resources:
  limits:
    cpu: 200m       # 0.2 CPU (vs 500m default)
    memory: 256Mi   # 256MB RAM (vs 512Mi default)
  requests:
    cpu: 50m        # 0.05 CPU
    memory: 64Mi    # 64MB RAM

# ========================================
# Health Checks
# ========================================

livenessProbe:
  tcpSocket:
    port: memcached
  initialDelaySeconds: 10
  periodSeconds: 20       # Check every 20s (vs 10s default)
  timeoutSeconds: 5
  successThreshold: 1
  failureThreshold: 3

readinessProbe:
  tcpSocket:
    port: memcached
  initialDelaySeconds: 5
  periodSeconds: 10
  timeoutSeconds: 3
  successThreshold: 1
  failureThreshold: 3

# ========================================
# High Availability
# ========================================

# Disabled for home servers
autoscaling:
  enabled: false

podDisruptionBudget:
  enabled: false

networkPolicy:
  enabled: false

# ========================================
# Node Selection
# ========================================

nodeSelector: {}
# Example for Raspberry Pi:
# nodeSelector:
#   kubernetes.io/arch: arm64

tolerations: []

affinity: {}

# ========================================
# Monitoring
# ========================================

# Prometheus monitoring disabled by default
monitoring:
  enabled: false
  serviceMonitor:
    enabled: false

metrics:
  enabled: false

# ========================================
# Notes for Home Server Users
# ========================================

# Common use cases for home servers:
#
# 1. WordPress Caching:
#    - Install W3 Total Cache or WP Super Cache plugin
#    - Configure Memcached host: memcached:11211
#    - Typical memory usage: 50-100MB for small sites
#
# 2. Web Application Session Storage:
#    - PHP session.save_handler = memcached
#    - PHP session.save_path = "memcached:11211"
#    - Faster than file-based sessions
#
# 3. API Response Caching:
#    - Cache expensive API calls
#    - Set appropriate TTL based on data freshness
#    - Reduces external API rate limits
#
# 4. Database Query Caching:
#    - Cache frequent database queries
#    - Reduce database load
#    - Faster response times
#
# 5. Object/Fragment Caching:
#    - Cache rendered HTML fragments
#    - Store computed results
#    - Reduce CPU usage
#
# Access from application:
#
# PHP Example:
#   $memcached = new Memcached();
#   $memcached->addServer('memcached', 11211);
#   $memcached->set('key', 'value', 3600);  // 1 hour TTL
#   $value = $memcached->get('key');
#
# Python Example:
#   from pymemcache.client import base
#   client = base.Client(('memcached', 11211))
#   client.set('key', 'value', expire=3600)
#   value = client.get('key')
#
# Node.js Example:
#   const Memcached = require('memcached');
#   const memcached = new Memcached('memcached:11211');
#   memcached.set('key', 'value', 3600, callback);
#   memcached.get('key', callback);
#
# Monitoring commands:
#
# 1. Connect to Memcached:
#    kubectl exec -it deployment/memcached -- telnet localhost 11211
#
# 2. Get statistics:
#    stats
#
# 3. Get slab information:
#    stats slabs
#
# 4. Get item statistics:
#    stats items
#
# 5. Flush all data (use with caution):
#    flush_all
#
# Performance tips:
#
# - Monitor cache hit/miss ratio
# - Adjust maxMemory based on actual usage
# - Use namespacing to avoid key collisions
# - Set appropriate TTL values
# - Consider key compression for large objects
#
# Memory usage estimates:
#
# - Small WordPress site: 50-100MB
# - Medium WordPress site: 100-200MB
# - Multiple small apps: 100-150MB
# - Session storage: 20-50MB
#
# Troubleshooting:
#
# - High eviction rate: Increase maxMemory
# - Connection errors: Check maxConnections limit
# - Slow response: Check network latency
# - Out of memory: Reduce cache TTL or increase memory
#
# Security notes:
#
# - Memcached has no authentication by default
# - Use NetworkPolicy to restrict access
# - Keep within cluster (ClusterIP service)
# - Don't expose to internet
# - Use for non-sensitive data only
