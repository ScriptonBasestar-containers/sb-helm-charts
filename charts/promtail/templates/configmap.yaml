{{- if not .Values.promtail.existingConfigMap }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "promtail.configMapName" . }}
  labels:
    {{- include "promtail.labels" . | nindent 4 }}
data:
  promtail.yaml: |
    server:
      http_listen_port: {{ .Values.promtail.server.httpListenPort }}
      grpc_listen_port: {{ .Values.promtail.server.grpcListenPort }}
      log_level: {{ .Values.promtail.server.logLevel }}

    positions:
      filename: /tmp/positions.yaml

    clients:
      - url: {{ .Values.promtail.client.url }}
        {{- if .Values.promtail.client.tenantId }}
        tenant_id: {{ .Values.promtail.client.tenantId }}
        {{- end }}
        {{- if .Values.promtail.client.basicAuth.enabled }}
        basic_auth:
          username: {{ .Values.promtail.client.basicAuth.username }}
          password: {{ .Values.promtail.client.basicAuth.password }}
        {{- end }}
        {{- with .Values.promtail.client.externalLabels }}
        external_labels:
          {{- toYaml . | nindent 10 }}
        {{- end }}

    scrape_configs:
      # Scrape logs from Kubernetes pods
      - job_name: kubernetes-pods
        pipeline_stages:
          {{- if .Values.promtail.pipelineStages.cri.enabled }}
          # CRI parser for containerd/cri-o
          - cri: {}
          {{- end }}
          {{- if .Values.promtail.pipelineStages.docker.enabled }}
          # Docker parser
          - docker: {}
          {{- end }}
          # Extract log level
          - regex:
              expression: '(?P<level>(debug|info|warn|error|fatal|panic))'
          - labels:
              level:
          {{- with .Values.promtail.pipelineStages.custom }}
          {{- toYaml . | nindent 10 }}
          {{- end }}

        kubernetes_sd_configs:
          - role: pod

        relabel_configs:
          # Add namespace label
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace

          # Add pod name label
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod

          # Add container name label
          - source_labels: [__meta_kubernetes_pod_container_name]
            target_label: container

          # Add node name label
          - source_labels: [__meta_kubernetes_pod_node_name]
            target_label: node

          # Add pod labels as Loki labels
          - action: labelmap
            regex: __meta_kubernetes_pod_label_(.+)

          # Add pod annotations as Loki labels (if enabled)
          {{- if .Values.promtail.kubernetesSD.addPodAnnotations }}
          - action: labelmap
            regex: __meta_kubernetes_pod_annotation_(.+)
          {{- end }}

          # Set log path
          - source_labels: [__meta_kubernetes_pod_uid, __meta_kubernetes_pod_container_name]
            target_label: __path__
            separator: /
            replacement: /var/log/pods/*$1/*.log

      {{- if .Values.promtail.kubernetesSD.scrapeSystemd }}
      # Scrape systemd journal logs
      - job_name: journal
        journal:
          max_age: 12h
          labels:
            job: systemd-journal
        relabel_configs:
          - source_labels: ['__journal__systemd_unit']
            target_label: 'unit'
          - source_labels: ['__journal__hostname']
            target_label: 'hostname'
      {{- end }}

      {{- with .Values.promtail.additionalScrapeConfigs }}
      {{- toYaml . | nindent 6 }}
      {{- end }}

    {{- with .Values.promtail.config }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
{{- end }}
