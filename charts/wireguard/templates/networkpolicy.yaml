{{- if .Values.networkPolicy.enabled }}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "wireguard.fullname" . }}
  labels:
    {{- include "wireguard.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      {{- include "wireguard.selectorLabels" . | nindent 6 }}
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow WireGuard VPN connections
    - ports:
        - port: 51820
          protocol: UDP
      {{- if or .Values.networkPolicy.ingress.namespaceSelector .Values.networkPolicy.ingress.podSelector .Values.networkPolicy.ingress.ipBlocks }}
      from:
        {{- if .Values.networkPolicy.ingress.namespaceSelector }}
        - namespaceSelector:
            {{- toYaml .Values.networkPolicy.ingress.namespaceSelector | nindent 12 }}
        {{- end }}
        {{- if .Values.networkPolicy.ingress.podSelector }}
        - podSelector:
            {{- toYaml .Values.networkPolicy.ingress.podSelector | nindent 12 }}
        {{- end }}
        {{- if .Values.networkPolicy.ingress.ipBlocks }}
        {{- range .Values.networkPolicy.ingress.ipBlocks }}
        - ipBlock:
            cidr: {{ . }}
        {{- end }}
        {{- end }}
      {{- end }}
    {{- if .Values.service.dns.enabled }}
    # Allow DNS queries if DNS service is enabled
    - ports:
        - port: 53
          protocol: UDP
        - port: 53
          protocol: TCP
    {{- end }}
  egress:
    {{- if .Values.networkPolicy.egress.allowAll }}
    # Allow all egress traffic
    - {}
    {{- else if .Values.networkPolicy.egress.customRules }}
    # Custom egress rules
    {{- toYaml .Values.networkPolicy.egress.customRules | nindent 4 }}
    {{- else }}
    # Default: Allow DNS and all egress
    - ports:
        - port: 53
          protocol: UDP
        - port: 53
          protocol: TCP
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
    {{- end }}
{{- end }}
