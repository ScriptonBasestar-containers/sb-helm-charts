# pgAdmin - Production-Ready Example Configuration
# Copy and customize for your environment

# =============================================================================
# REQUIRED: Set admin credentials
# =============================================================================
pgadmin:
  defaultEmail: "admin@example.com"  # REQUIRED - pgAdmin login email
  defaultPassword: ""  # REQUIRED - Set a strong password

# =============================================================================
# Deployment Configuration
# =============================================================================
replicaCount: 1  # Single replica (use session affinity for multiple replicas)

image:
  repository: dpage/pgadmin4
  pullPolicy: IfNotPresent
  tag: ""  # Defaults to chart appVersion (8.13)

# =============================================================================
# pgAdmin Configuration
# =============================================================================
pgadmin:
  # Admin credentials
  defaultEmail: "admin@example.com"
  defaultPassword: ""  # SET THIS - stored in Kubernetes Secret

  # Server mode (web-based, multi-user)
  serverMode: true

  # Enhanced cookie security
  enhancedCookieProtection: true

  # Session timeout (minutes)
  sessionTimeout: 120  # 2 hours

  # Enable Two-Factor Authentication
  mfaSupported: true

  # Password policies
  passwordLengthMin: 12

  # Config database (SQLite by default, or external PostgreSQL)
  configDatabaseUri: "sqlite:////var/lib/pgadmin/pgadmin4.db"
  # For external PostgreSQL (recommended for HA):
  # configDatabaseUri: "postgresql://pgadmin:password@postgres:5432/pgadmin"

  # Storage path
  storagePath: "/var/lib/pgadmin/storage"

  # Log levels
  logLevel: "INFO"  # CRITICAL, ERROR, WARNING, INFO, DEBUG, NOTSET
  consoleLogLevel: "INFO"

  # Extra environment variables
  extraEnv: []
  # - name: PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED
  #   value: "True"

# =============================================================================
# Pre-configured PostgreSQL Servers
# =============================================================================
servers:
  enabled: true
  config:
    # Production database
    - Name: "Production PostgreSQL"
      Group: "Production"
      Host: "postgresql-prod.database.svc.cluster.local"
      Port: 5432
      MaintenanceDB: "postgres"
      Username: "postgres"
      SSLMode: "prefer"
      Comment: "Production PostgreSQL cluster"

    # Development database
    - Name: "Development PostgreSQL"
      Group: "Development"
      Host: "postgresql-dev.database.svc.cluster.local"
      Port: 5432
      MaintenanceDB: "postgres"
      Username: "postgres"
      SSLMode: "disable"
      Comment: "Development PostgreSQL instance"

    # Analytics database
    - Name: "Analytics PostgreSQL"
      Group: "Analytics"
      Host: "postgresql-analytics.database.svc.cluster.local"
      Port: 5432
      MaintenanceDB: "postgres"
      Username: "readonly"
      SSLMode: "require"
      Comment: "Read-only analytics database"

# =============================================================================
# Security Configuration
# =============================================================================
serviceAccount:
  create: true
  annotations: {}
  name: ""

podSecurityContext:
  fsGroup: 5050
  runAsUser: 5050
  runAsNonRoot: true

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: false  # pgAdmin needs write access
  runAsNonRoot: true
  runAsUser: 5050

# =============================================================================
# Service Configuration
# =============================================================================
service:
  type: ClusterIP
  port: 80
  targetPort: 80
  annotations:
    # Session affinity for multiple replicas
    service.kubernetes.io/topology-mode: "Auto"

# =============================================================================
# Ingress (Web Access)
# =============================================================================
# ingress:
#   enabled: true
#   className: nginx
#   annotations:
#     cert-manager.io/cluster-issuer: letsencrypt-prod
#     # Enable session affinity (sticky sessions)
#     nginx.ingress.kubernetes.io/affinity: cookie
#     nginx.ingress.kubernetes.io/session-cookie-name: pgadmin-session
#     # Basic auth (optional additional security)
#     # nginx.ingress.kubernetes.io/auth-type: basic
#     # nginx.ingress.kubernetes.io/auth-secret: pgadmin-basic-auth
#   hosts:
#     - host: pgadmin.example.com
#       paths:
#         - path: /
#           pathType: Prefix
#   tls:
#     - secretName: pgadmin-tls
#       hosts:
#         - pgadmin.example.com

# =============================================================================
# Persistence (Required for Config and Session Data)
# =============================================================================
persistence:
  enabled: true
  storageClass: ""  # Use default or specify
  accessMode: ReadWriteOnce
  size: 5Gi  # Increase based on number of servers and query history
  annotations: {}

# =============================================================================
# Resource Configuration
# =============================================================================
resources:
  limits:
    cpu: 1000m
    memory: 1Gi
  requests:
    cpu: 200m
    memory: 256Mi

# =============================================================================
# Auto-scaling (Optional)
# =============================================================================
autoscaling:
  enabled: false  # Enable for high-traffic scenarios
  minReplicas: 2
  maxReplicas: 5
  targetCPUUtilizationPercentage: 75
  targetMemoryUtilizationPercentage: 80

# =============================================================================
# Health Probes
# =============================================================================
readinessProbe:
  enabled: true
  httpGet:
    path: /misc/ping
    port: 80
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  successThreshold: 1
  failureThreshold: 3

livenessProbe:
  enabled: true
  httpGet:
    path: /misc/ping
    port: 80
  initialDelaySeconds: 60
  periodSeconds: 20
  timeoutSeconds: 5
  successThreshold: 1
  failureThreshold: 3

# =============================================================================
# Network Policy (Optional)
# =============================================================================
networkPolicy:
  enabled: true
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow ingress from anywhere (controlled by ingress)
    - from:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 80
  egress:
    # Allow DNS
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: UDP
          port: 53
    # Allow PostgreSQL connections
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 5432

# =============================================================================
# Pod Disruption Budget (Optional)
# =============================================================================
podDisruptionBudget:
  enabled: false  # Enable for HA deployments
  minAvailable: 1

# =============================================================================
# Pod Scheduling
# =============================================================================
nodeSelector: {}
# Example: Run on specific nodes
#   node-role.kubernetes.io/database: "true"

tolerations: []
# Example: Tolerate database taint
#   - key: "database"
#     operator: "Equal"
#     value: "true"
#     effect: "NoSchedule"

affinity: {}
# Example: Co-locate with databases
#   podAffinity:
#     preferredDuringSchedulingIgnoredDuringExecution:
#       - weight: 100
#         podAffinityTerm:
#           labelSelector:
#             matchExpressions:
#               - key: app
#                 operator: In
#                 values:
#                   - postgresql
#           topologyKey: kubernetes.io/hostname

# =============================================================================
# Usage Examples
# =============================================================================
# Access pgAdmin:
#   kubectl port-forward svc/pgadmin 8080:80
#   Open: http://localhost:8080
#   Login: admin@example.com / <your-password>
#
# Connect to PostgreSQL:
#   - Pre-configured servers appear in left panel
#   - Right-click server â†’ Connect
#   - Enter PostgreSQL password
#
# Backup metadata (server connections, query history):
#   make -f make/ops/pgadmin.mk pgadmin-backup-metadata
#
# Restore metadata:
#   make -f make/ops/pgadmin.mk pgadmin-restore-metadata FILE=<file>
#
# List configured servers:
#   make -f make/ops/pgadmin.mk pgadmin-list-servers
#
# Test connection:
#   make -f make/ops/pgadmin.mk pgadmin-test-connection HOST=postgresql.default.svc.cluster.local
#
# Operational commands:
#   make -f make/ops/pgadmin.mk pgadmin-port-forward  # Access locally
#   make -f make/ops/pgadmin.mk pgadmin-get-password  # Get admin password
#   make -f make/ops/pgadmin.mk pgadmin-logs  # View logs
