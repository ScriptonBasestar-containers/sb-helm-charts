# Default values for redis.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# Deployment mode
# - standalone: single instance (default)
# - replica: 1 primary + N replicas (manual failover)
# - sentinel / cluster: NOT implemented yet (chart will fail fast)
mode: standalone

# Redis configuration
redis:
  # Redis password (leave empty for no password)
  password: ""
  # Use an existing Secret that contains the Redis password (overrides redis.password)
  existingSecret: ""
  # Key inside the secret that stores the password (used for generated and existing secrets)
  secretKeyName: redis-password

  # Redis configuration file (redis.conf)
  # If not provided, uses Redis defaults
  config: |
    # Redis 7.x configuration
    # Network
    bind 0.0.0.0
    protected-mode no
    port 6379
    tcp-backlog 511
    timeout 0
    tcp-keepalive 300

    # General
    daemonize no
    supervised no
    loglevel notice

    # Snapshotting (persistence)
    save 900 1
    save 300 10
    save 60 10000
    stop-writes-on-bgsave-error yes
    rdbcompression yes
    rdbchecksum yes
    dbfilename dump.rdb
    dir /data

    # Replication
    # replica-serve-stale-data yes
    # replica-read-only yes

    # Security
    # requirepass your-password-here

    # Limits
    maxmemory 256mb
    maxmemory-policy allkeys-lru
    maxclients 10000

    # Append Only File (AOF)
    appendonly no
    appendfilename "appendonly.aof"
    appendfsync everysec
    no-appendfsync-on-rewrite no
    auto-aof-rewrite-percentage 100
    auto-aof-rewrite-min-size 64mb

    # Slow log
    slowlog-log-slower-than 10000
    slowlog-max-len 128

  # Use existing ConfigMap for redis.conf (optional)
  existingConfigMap: ""

  # Redis command-line arguments (overrides config file)
  args: []
  # Example:
  # - "--maxmemory 512mb"
  # - "--maxmemory-policy allkeys-lru"

# Master-Slave Replication
# Deprecated in favor of `mode: replica`.
# When enabled, creates 1 master + N replicas with read-only replication.
# If mode is set, it takes precedence and this block is ignored for mode detection.
replication:
  enabled: false  # Default: single instance mode
  # Number of read-only replicas (when replication.enabled=true)
  replicas: 2
  # Automatically created services:
  # - redis.{namespace}.svc.cluster.local → master (read/write)
  # - redis-master.{namespace}.svc.cluster.local → master explicitly
  # Individual replica access via StatefulSet DNS:
  # - redis-1.redis-headless.{namespace}.svc.cluster.local → replica 1
  # - redis-2.redis-headless.{namespace}.svc.cluster.local → replica 2

# Persistence
persistence:
  enabled: true
  storageClass: ""  # Use default storage class if empty
  accessMode: ReadWriteOnce
  size: 8Gi
  existingClaim: ""

# Replica count (only used when replication.enabled=false)
# When replication.enabled=true, uses 1 master + replication.replicas slaves
replicaCount: 1

# Container image configuration
image:
  repository: redis
  pullPolicy: IfNotPresent
  tag: "7.4.1-alpine"

# Image pull secrets for private registries
imagePullSecrets: []

# Override chart name
nameOverride: ""
fullnameOverride: ""

# Service account configuration
serviceAccount:
  create: true
  automount: true
  annotations: {}
  name: ""

# RBAC Configuration
rbac:
  # Specifies whether RBAC resources should be created
  create: true
  # Annotations to add to the Role and RoleBinding
  annotations: {}

# Pod annotations
podAnnotations: {}

# Pod labels
podLabels: {}

# Pod security context
podSecurityContext:
  fsGroup: 999  # redis group

# Container security context
securityContext:
  runAsUser: 999  # redis user
  runAsGroup: 999
  runAsNonRoot: true
  readOnlyRootFilesystem: false
  capabilities:
    drop:
      - ALL

# Service configuration
service:
  type: ClusterIP
  port: 6379
  targetPort: 6379
  annotations: {}

# Resource limits and requests
resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 128Mi

# Liveness probe configuration
livenessProbe:
  tcpSocket:
    port: redis
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 6
  successThreshold: 1

# Readiness probe configuration
readinessProbe:
  exec:
    command:
      - redis-cli
      - ping
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3
  successThreshold: 1

# Startup probe (for slow initialization)
startupProbe:
  tcpSocket:
    port: redis
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 30
  successThreshold: 1

# Autoscaling configuration (not recommended for stateful Redis)
autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 3
  targetCPUUtilizationPercentage: 80

# Pod Disruption Budget
# Monitoring configuration
monitoring:
  enabled: false
  serviceMonitor:
    enabled: false
    interval: 30s
    labels: {}
    path: /metrics

# Redis Exporter for Prometheus (sidecar)
metrics:
  enabled: false
  image:
    repository: oliver006/redis_exporter
    tag: v1.55.0-alpine
    pullPolicy: IfNotPresent
  resources:
    limits:
      cpu: 100m
      memory: 128Mi
    requests:
      cpu: 50m
      memory: 64Mi
  port: 9121

# Pod Disruption Budget
# Ensures minimum availability during voluntary disruptions (e.g., node drains)
podDisruptionBudget:
  enabled: false
  # Minimum number of pods that must be available
  # For StatefulSet with 1 replica, use minAvailable: 1
  minAvailable: 1
  # Maximum number of pods that can be unavailable
  # Use either minAvailable or maxUnavailable, not both
  # maxUnavailable: 1

# Network Policy
# Restricts network access to Redis pods
networkPolicy:
  enabled: false
  # Ingress rules
  ingress:
    # Allow ingress from pods with specific labels
    - from:
      - podSelector:
          matchLabels: {}
      ports:
        - protocol: TCP
          port: 6379
  # Egress rules (optional)
  egress: []

# Node selector
nodeSelector: {}

# Tolerations
tolerations: []

# Affinity rules
affinity: {}
# Example anti-affinity for HA:
# affinity:
#   podAntiAffinity:
#     preferredDuringSchedulingIgnoredDuringExecution:
#       - weight: 100
#         podAffinityTerm:
#           labelSelector:
#             matchExpressions:
#               - key: app.kubernetes.io/name
#                 operator: In
#                 values:
#                   - redis
#           topologyKey: kubernetes.io/hostname

# Additional environment variables
extraEnv: []
# Example:
# - name: REDIS_EXTRA_FLAGS
#   value: "--maxmemory 1gb"

# Additional environment variables from ConfigMap or Secret
extraEnvFrom: []

# Additional volumes
extraVolumes: []

# Additional volume mounts
extraVolumeMounts: []

# Init containers
initContainers: []
# Example: sysctl tuning for production
# - name: sysctl
#   image: busybox
#   command:
#     - sh
#     - -c
#     - |
#       sysctl -w vm.overcommit_memory=1
#       sysctl -w net.core.somaxconn=65535
#   securityContext:
#     privileged: true

# Lifecycle hooks
lifecycle: {}
# Example:
# lifecycle:
#   preStop:
#     exec:
#       command: ["/bin/sh", "-c", "redis-cli shutdown save"]

# ============================================================================
# Backup & Recovery Configuration
# ============================================================================
# IMPORTANT: This section is for DOCUMENTATION ONLY.
# Backup/recovery operations are performed via Makefile targets, NOT CronJobs.
# See docs/redis-backup-guide.md for comprehensive procedures.
backup:
  # This flag is DOCUMENTATION ONLY - no automated CronJobs are created
  enabled: false

  # Backup documentation and strategy
  documentation:
    # Backup strategy overview
    strategy: "Configuration + RDB Snapshots + AOF Persistence + Replication"

    # Available backup tools (via Makefile)
    tools:
      - "make -f make/ops/redis.mk redis-full-backup"
      - "make -f make/ops/redis.mk redis-backup-rdb"
      - "make -f make/ops/redis.mk redis-backup-aof"
      - "make -f make/ops/redis.mk redis-backup-config"

    # Backup components
    components:
      configuration:
        description: "Redis configuration and Kubernetes manifests"
        command: "make -f make/ops/redis.mk redis-backup-config"
        frequency: "Before changes"

      rdb_snapshots:
        description: "Point-in-time binary snapshots (dump.rdb)"
        command: "make -f make/ops/redis.mk redis-backup-rdb"
        frequency: "Daily"
        retention: "30 days"

      aof_persistence:
        description: "Append-only file for durability"
        command: "make -f make/ops/redis.mk redis-backup-aof"
        frequency: "Daily"
        retention: "7 days"

      replication:
        description: "Hot standby via primary-replica architecture"
        command: "Enable via mode: replica"
        rpo: "Near-zero (async replication lag: < 1 second)"

    # Recovery targets
    targets:
      rto: "< 1 hour"
      rpo: "24 hours"

    # Best practices
    best_practices:
      - "Enable both RDB and AOF for maximum durability"
      - "Schedule daily backups via external tools (Velero, Kasten K10, CronJob)"
      - "Enable replication for hot standby"
      - "Store backups offsite (S3, MinIO, NFS)"
      - "Test recovery procedures regularly (quarterly)"
      - "Implement 3-2-1 backup rule (3 copies, 2 storage types, 1 offsite)"

    # Quick reference
    quick_reference:
      full_backup: "make -f make/ops/redis.mk redis-full-backup"
      restore_rdb: "make -f make/ops/redis.mk redis-restore-rdb BACKUP_FILE=..."
      restore_aof: "make -f make/ops/redis.mk redis-restore-aof BACKUP_FILE=..."
      disaster_recovery: "make -f make/ops/redis.mk redis-disaster-recovery BACKUP_DIR=..."

# ============================================================================
# Upgrade Configuration
# ============================================================================
# IMPORTANT: This section is for DOCUMENTATION ONLY.
# Upgrade operations are performed manually via Helm, NOT automated.
# See docs/redis-upgrade-guide.md for comprehensive procedures.
upgrade:
  # This flag is DOCUMENTATION ONLY - manual upgrade process
  enabled: false

  # Pre-upgrade backup (MANDATORY)
  preUpgradeBackup: true

  # Upgrade documentation and strategies
  documentation:
    # Available upgrade strategies
    strategies:
      rolling:
        description: "Zero-downtime upgrade for replica mode"
        downtime: "None (brief connection resets)"
        best_for: "Production replica deployments"
        command: "helm upgrade redis charts/redis --set image.tag=7.4.1-alpine --reuse-values"

      in_place:
        description: "Simple upgrade with brief downtime"
        downtime: "1-5 minutes"
        best_for: "Standalone mode or development"
        command: "helm upgrade redis charts/redis --set image.tag=7.4.1-alpine --reuse-values"

      blue_green:
        description: "Parallel deployment with traffic cutover"
        downtime: "None (requires traffic switch)"
        best_for: "Maximum safety with easy rollback"
        steps:
          - "Deploy green environment with new version"
          - "Configure green as replica of blue"
          - "Wait for full sync"
          - "Promote green to primary"
          - "Switch traffic to green"

      dump_restore:
        description: "Clean state upgrade via backup/restore"
        downtime: "10-30 minutes"
        best_for: "Major version upgrades with breaking changes"
        steps:
          - "Create RDB dump from current deployment"
          - "Uninstall old deployment"
          - "Install new version"
          - "Restore data from dump"

    # Pre-upgrade checklist
    pre_upgrade:
      - "Check current Redis version: make -f make/ops/redis.mk redis-version"
      - "Review release notes for breaking changes"
      - "Create full backup: make -f make/ops/redis.mk redis-full-backup"
      - "Verify current configuration: helm get values redis -n redis"
      - "Test upgrade in non-production environment"
      - "Schedule maintenance window (if needed)"

    # Post-upgrade validation
    post_upgrade:
      - "Verify version: make -f make/ops/redis.mk redis-version"
      - "Health check: make -f make/ops/redis.mk redis-health"
      - "Replication status: make -f make/ops/redis.mk redis-replication-info"
      - "Data integrity: make -f make/ops/redis.mk redis-dbsize"
      - "Performance test: make -f make/ops/redis.mk redis-latency"

    # Rollback procedures
    rollback:
      helm_rollback:
        description: "Fastest rollback method"
        command: "helm rollback redis -n redis"
        downtime: "< 2 minutes"

      restore_backup:
        description: "Restore from pre-upgrade backup"
        command: "make -f make/ops/redis.mk redis-restore-rdb BACKUP_FILE=..."
        downtime: "5-15 minutes"

      blue_green_failback:
        description: "Switch traffic back to blue environment"
        command: "kubectl patch service redis -n redis -p '{...}'"
        downtime: "None"

    # Version-specific notes
    version_notes:
      "6.x_to_7.x":
        breaking_changes:
          - "ACL system changes (stricter defaults)"
          - "Replication protocol enhancements"
          - "Some config parameters renamed"
        recommended_strategy: "blue_green"

      "7.0_to_7.2":
        breaking_changes:
          - "Minor internal optimizations"
        recommended_strategy: "rolling"

      "7.2_to_7.4":
        breaking_changes:
          - "Minimal changes"
        recommended_strategy: "rolling"

    # Quick reference
    quick_reference:
      pre_check: "make -f make/ops/redis.mk redis-pre-upgrade-check"
      post_check: "make -f make/ops/redis.mk redis-post-upgrade-check"
      rollback: "helm rollback redis -n redis"
