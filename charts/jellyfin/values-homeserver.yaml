# Jellyfin Helm Chart - Home Server Configuration
#
# Optimized for:
# - Raspberry Pi 4 (4GB+)
# - Intel NUC / Mini PC
# - Small home servers
#
# Features:
# - Reduced resource allocation (2GB RAM limit)
# - Intel QuickSync hardware acceleration
# - Single media library
# - Suitable for 1-5 concurrent streams

# ========================================
# Jellyfin Configuration
# ========================================
jellyfin:
  # Media directories - single large library
  mediaDirectories:
    - name: media
      mountPath: /media
      # Use hostPath for direct access to local storage
      hostPath: /mnt/media
      # Or use PVC
      # existingClaim: "media-pvc"
      # size: 500Gi

  # Intel QuickSync (common in NUC, some mini PCs)
  hardwareAcceleration:
    enabled: true
    type: "intel-qsv"
    intel:
      renderDevice: "/dev/dri/renderD128"

  transcoding:
    cacheSize: 5Gi
    threads: 0  # Auto-detect

  network:
    publishedServerUrl: ""  # Set to your home network URL
    enableDlna: false  # Enable if you have DLNA devices

# ========================================
# Persistence - Reduced sizes
# ========================================
persistence:
  enabled: true

  config:
    enabled: true
    storageClass: ""
    size: 2Gi  # Reduced from 5Gi
    accessMode: ReadWriteOnce
    mountPath: /config

  cache:
    enabled: true
    storageClass: ""
    size: 5Gi  # Reduced from 10Gi
    accessMode: ReadWriteOnce
    mountPath: /cache

# ========================================
# Resources - Home Server Optimized
# ========================================
replicaCount: 1

resources:
  limits:
    cpu: 2000m    # 2 cores max
    memory: 2Gi   # 2GB max (50% of default)
  requests:
    cpu: 500m     # 0.5 core baseline
    memory: 1Gi   # 1GB baseline

# ========================================
# Pod Security - Intel QSV Groups
# ========================================
# Note: supplementalGroups (44, 109) are automatically added by the chart
# when jellyfin.hardwareAcceleration.type=intel-qsv
podSecurityContext:
  fsGroup: 1000
  runAsUser: 1000
  runAsGroup: 1000
  runAsNonRoot: true

# ========================================
# Service - ClusterIP Only
# ========================================
service:
  type: ClusterIP
  ports:
    - name: http
      port: 8096
      targetPort: 8096
      protocol: TCP

# ========================================
# Ingress - Disabled by Default
# ========================================
ingress:
  enabled: false
  # Enable for remote access:
  # className: "nginx"
  # annotations:
  #   nginx.ingress.kubernetes.io/proxy-body-size: 5G
  #   cert-manager.io/cluster-issuer: letsencrypt-prod
  # hosts:
  #   - host: jellyfin.home.local
  #     paths:
  #       - path: /
  #         pathType: Prefix
  # tls:
  #   - secretName: jellyfin-tls
  #     hosts:
  #       - jellyfin.home.local

# ========================================
# Health Probes - Conservative Timing
# ========================================
livenessProbe:
  enabled: true
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 60
  periodSeconds: 30  # Less frequent checks
  timeoutSeconds: 10
  failureThreshold: 6

readinessProbe:
  enabled: true
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 30
  periodSeconds: 20
  timeoutSeconds: 10
  failureThreshold: 3

startupProbe:
  enabled: true
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 10
  failureThreshold: 30

# ========================================
# Scheduling - Intel GPU Node Affinity
# ========================================
nodeSelector: {}
  # intel.feature.node.kubernetes.io/gpu: "true"

tolerations: []

affinity: {}
  # nodeAffinity:
  #   preferredDuringSchedulingIgnoredDuringExecution:
  #     - weight: 100
  #       preference:
  #         matchExpressions:
  #           - key: intel.feature.node.kubernetes.io/gpu
  #             operator: In
  #             values:
  #               - "true"

# ========================================
# Monitoring - Disabled
# ========================================
monitoring:
  enabled: false

autoscaling:
  enabled: false

podDisruptionBudget:
  enabled: false

networkPolicy:
  enabled: false
