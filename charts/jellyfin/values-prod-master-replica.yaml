# Jellyfin values for Production - Single Node
# Note: Jellyfin does not support horizontal scaling (uses local SQLite database)
# For production HA, consider database replication or backup strategies
# Use: helm install jellyfin ./charts/jellyfin -f charts/jellyfin/values-prod-master-replica.yaml

# Jellyfin configuration
jellyfin:
  # Media directories - configure based on your media library
  mediaDirectories: []
  # Example:
  # - name: movies
  #   mountPath: /media/movies
  #   size: 500Gi
  # - name: tvshows
  #   mountPath: /media/tvshows
  #   size: 1Ti
  # - name: music
  #   mountPath: /media/music
  #   size: 200Gi

  # Hardware acceleration (highly recommended for production)
  hardwareAcceleration:
    enabled: false  # Set to true and configure GPU type
    type: "none"  # Change to intel-qsv, nvidia-nvenc, or amd-vaapi

    intel:
      renderDevice: "/dev/dri/renderD128"

    nvidia:
      runtimeClassName: "nvidia"

  transcoding:
    cacheSize: 20Gi  # Larger cache for production
    threads: 0  # Auto-detect

  network:
    publishedServerUrl: ""  # Set your public URL
    enableDlna: false

# No external database needed (SQLite)
postgresql:
  enabled: false
mysql:
  enabled: false
redis:
  enabled: false

# Persistence
persistence:
  enabled: true

  config:
    enabled: true
    storageClass: ""
    size: 10Gi
    accessMode: ReadWriteOnce
    mountPath: /config

  cache:
    enabled: true
    storageClass: ""
    size: 20Gi
    accessMode: ReadWriteOnce
    mountPath: /cache

replicaCount: 1  # Cannot scale horizontally

strategy:
  type: Recreate

image:
  repository: jellyfin/jellyfin
  tag: "10.10.3"
  pullPolicy: IfNotPresent

serviceAccount:
  create: true
  automount: true

podAnnotations:
  prometheus.io/scrape: "false"  # No native metrics

podLabels:
  environment: "production"
  tier: "media"

podSecurityContext:
  fsGroup: 1000
  runAsUser: 1000
  runAsGroup: 1000
  runAsNonRoot: true
  # Add supplementalGroups for GPU access if needed
  # Intel QSV: [44, 109]
  supplementalGroups: []

securityContext:
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: false
  allowPrivilegeEscalation: false

service:
  type: ClusterIP
  ports:
    - name: http
      port: 8096
      targetPort: 8096
      protocol: TCP

ingress:
  enabled: true
  className: "nginx"
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "10G"
    nginx.ingress.kubernetes.io/proxy-buffering: "off"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
  hosts:
    - host: jellyfin.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: jellyfin-tls
      hosts:
        - jellyfin.example.com

resources:
  limits:
    cpu: 4000m
    memory: 4Gi
  requests:
    cpu: 1000m
    memory: 2Gi

# GPU resources (uncomment if using GPU)
# resources:
#   limits:
#     nvidia.com/gpu: 1  # For NVIDIA
#     cpu: 4000m
#     memory: 4Gi

livenessProbe:
  enabled: true
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 60
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 6

readinessProbe:
  enabled: true
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

startupProbe:
  enabled: true
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 5
  failureThreshold: 30

autoscaling:
  enabled: false  # Not supported - SQLite database

podDisruptionBudget:
  enabled: true
  minAvailable: 1

networkPolicy:
  enabled: true
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
      ports:
        - protocol: TCP
          port: 8096
  egress:
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: UDP
          port: 53  # DNS

# GPU node scheduling (uncomment if using GPU)
# nodeSelector:
#   intel.feature.node.kubernetes.io/gpu: "true"  # For Intel QSV
#   # nvidia.com/gpu.present: "true"  # For NVIDIA

# tolerations:
#   - key: nvidia.com/gpu
#     operator: Exists
#     effect: NoSchedule

nodeSelector: {}
tolerations: []
affinity: {}
