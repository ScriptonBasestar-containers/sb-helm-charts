# Default values for alertmanager
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

replicaCount: 1

image:
  repository: prom/alertmanager
  pullPolicy: IfNotPresent
  # Overrides the image tag whose default is the chart appVersion.
  tag: ""

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

# RBAC configuration
rbac:
  # Specifies whether RBAC resources should be created
  create: true
  # Annotations to add to the Role and RoleBinding
  annotations: {}

podAnnotations: {}

podSecurityContext:
  runAsUser: 65534
  runAsNonRoot: true
  fsGroup: 65534

securityContext:
  readOnlyRootFilesystem: true
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL

service:
  type: ClusterIP
  port: 9093
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9093"
  # clusterIP: ""
  # loadBalancerIP: ""
  # loadBalancerSourceRanges: []
  # nodePort: 30093

# Alertmanager configuration
alertmanager:
  # Data retention period
  retention: "120h"

  # Extra command-line arguments
  extraArgs: []
  # - --log.level=debug
  # - --cluster.reconnect-timeout=5m

# Alertmanager configuration file
config:
  global:
    # The smarthost and SMTP sender used for mail notifications
    resolveTimeout: "5m"

    # SMTP configuration (optional)
    smtp: {}
    #   from: "alertmanager@example.com"
    #   smarthost: "smtp.example.com:587"
    #   authUsername: "alertmanager@example.com"
    #   authPassword: "password"
    #   requireTLS: true

    # Slack API URL (optional)
    slackApiUrl: ""

    # PagerDuty URL (optional)
    pagerdutyUrl: ""

    # Opsgenie API URL (optional)
    opsgenieApiUrl: ""

    # WeChat API URL (optional)
    wechatApiUrl: ""

    # VictorOps API URL (optional)
    victoropsApiUrl: ""

    # HTTP client configuration
    httpConfig: {}
    #   tls_config:
    #     insecure_skip_verify: false

  # List of notification template files
  templates: []
  # - "/etc/alertmanager/templates/*.tmpl"

  # The root route on which each incoming alert enters
  route:
    # The labels by which incoming alerts are grouped together
    groupBy: ['alertname', 'cluster', 'service']

    # When a new group of alerts is created by an incoming alert, wait at
    # least 'group_wait' to send the initial notification
    groupWait: 10s

    # When the first notification was sent, wait 'group_interval' to send a batch
    # of new alerts that started firing for that group
    groupInterval: 10s

    # If an alert has successfully been sent, wait 'repeat_interval' to
    # resend them
    repeatInterval: 12h

    # A default receiver
    receiver: default

    # Child routes (optional)
    routes: []
    # - match:
    #     severity: critical
    #   receiver: critical-alerts
    #   continue: true
    # - match:
    #     severity: warning
    #   receiver: warning-alerts

  # Inhibition rules allow to mute a set of alerts given that another alert is firing
  inhibitRules: []
  # - source_match:
  #     severity: 'critical'
  #   target_match:
  #     severity: 'warning'
  #   equal: ['alertname', 'cluster', 'service']

  # Receivers is a list of notification receivers
  receivers:
    - name: default
      # email_configs:
      # - to: "admin@example.com"
      # slack_configs:
      # - channel: "#alerts"
      #   text: "{{ range .Alerts }}{{ .Annotations.summary }}\n{{ end }}"
      # pagerduty_configs:
      # - service_key: "your-service-key"
      # webhook_configs:
      # - url: "http://example.com/webhook"

# ServiceMonitor for Prometheus Operator
serviceMonitor:
  enabled: false
  interval: 30s
  scrapeTimeout: 10s
  labels: {}
  #   prometheus: kube-prometheus
  metricRelabelings: []
  relabelings: []

# PodDisruptionBudget
podDisruptionBudget:
  enabled: false
  # minAvailable: 1
  # maxUnavailable: 1

# Persistence
persistence:
  enabled: false
  # storageClass: ""
  accessModes:
    - ReadWriteOnce
  size: 2Gi
  annotations: {}

resources:
  limits:
    cpu: 200m
    memory: 256Mi
  requests:
    cpu: 50m
    memory: 64Mi

livenessProbe:
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 1
  failureThreshold: 3

readinessProbe:
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 1
  failureThreshold: 3

nodeSelector: {}

tolerations: []

affinity: {}

priorityClassName: ""

# Backup & Recovery Configuration
# Documentation only - no automated CronJobs are created
# All backup operations are performed via Makefile targets
backup:
  enabled: false  # Documentation flag only - does not create CronJobs
  documentation:
    strategy: "Configuration + Silences + Notification Templates + Data Directory"
    tools:
      - "kubectl (ConfigMap export)"
      - "amtool / API (silence export)"
      - "VolumeSnapshot (PVC snapshots)"
    components:
      configuration:
        priority: "Critical"
        size: "<10 KB"
        method: "ConfigMap export"
        description: "alertmanager.yml with routing rules and receivers"
      silences:
        priority: "Important"
        size: "<1 MB"
        method: "API export via amtool or curl"
        description: "Active silences to prevent alert noise during maintenance"
      notification_templates:
        priority: "Important"
        size: "<100 KB"
        method: "ConfigMap export"
        description: "Custom notification templates for alert formatting"
      data_directory:
        priority: "Secondary"
        size: "<100 MB"
        method: "PVC snapshot"
        description: "Runtime data including silences, notification log, and mesh state"
    targets:
      rto: "< 30 minutes"  # Recovery Time Objective
      rpo: "1 hour"        # Recovery Point Objective
    makefile_targets:
      backup:
        - "make -f make/ops/alertmanager.mk am-backup-config          # Backup configuration"
        - "make -f make/ops/alertmanager.mk am-backup-silences        # Backup silences"
        - "make -f make/ops/alertmanager.mk am-backup-templates       # Backup templates"
        - "make -f make/ops/alertmanager.mk am-backup-all             # Full backup"
      restore:
        - "make -f make/ops/alertmanager.mk am-restore-config FILE=<backup.yaml>   # Restore config"
        - "make -f make/ops/alertmanager.mk am-restore-silences FILE=<backup.json> # Restore silences"
    detailed_guide: "docs/alertmanager-backup-guide.md"

# Upgrade Configuration
# Documentation only - all upgrades are performed manually via Helm
# Pre-upgrade backups are strongly recommended
upgrade:
  enabled: false  # Documentation flag only - manual process via Helm
  preUpgradeBackup: true  # Recommendation to backup before upgrade
  documentation:
    strategies:
      rolling:
        description: "StatefulSet rolling update with pod-by-pod replacement"
        downtime: "< 1 minute (brief traffic disruption)"
        use_case: "HA deployments with replicaCount >= 3"
        requirements:
          - "replicaCount >= 3"
          - "podDisruptionBudget.enabled=true with minAvailable=2"
      blue_green:
        description: "Parallel deployment with traffic switch to new cluster"
        downtime: "None (zero downtime)"
        use_case: "Major version upgrades or zero-downtime requirements"
        requirements:
          - "Sufficient cluster resources for parallel deployment"
          - "Update Prometheus alerting.alertmanagers configuration"
      maintenance_window:
        description: "Full cluster restart with complete downtime"
        downtime: "5-15 minutes"
        use_case: "Single-replica deployments or major version upgrades"
        requirements:
          - "Scheduled maintenance window"
          - "Backup of configuration and silences"
    version_compatibility:
      alertmanager_versions:
        - "0.27.x: Native OpenTelemetry support, improved clustering"
        - "0.26.x: Enhanced silence management, webhook retry logic"
        - "0.25.x: Discord/Telegram receiver support"
        - "0.24.x: Opsgenie v2 API, WeChat Work receiver"
      prometheus_compatibility:
        - "Alertmanager 0.27.x: Prometheus 2.45.x - 2.50.x"
        - "Alertmanager 0.26.x: Prometheus 2.40.x - 2.48.x"
        - "Alertmanager 0.25.x: Prometheus 2.35.x - 2.45.x"
        - "Alertmanager 0.24.x: Prometheus 2.28.x - 2.40.x"
    makefile_targets:
      pre_upgrade:
        - "make -f make/ops/alertmanager.mk am-pre-upgrade-check   # Pre-upgrade validation"
        - "make -f make/ops/alertmanager.mk am-backup-all          # Backup before upgrade"
      post_upgrade:
        - "make -f make/ops/alertmanager.mk am-post-upgrade-check  # Post-upgrade validation"
      rollback:
        - "make -f make/ops/alertmanager.mk am-upgrade-rollback    # Rollback to previous release"
    detailed_guide: "docs/alertmanager-upgrade-guide.md"
