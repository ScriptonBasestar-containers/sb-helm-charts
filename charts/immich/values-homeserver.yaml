# Immich Helm Chart - Home Server Configuration
#
# Optimized for:
# - Raspberry Pi 4 (8GB recommended for ML features)
# - Intel NUC / Mini PC with integrated GPU
# - Small home servers
# - Personal photo libraries (5,000-50,000 photos)
#
# Features:
# - Reduced resource allocation for server (1 CPU, 1.5Gi RAM)
# - ML service optimized for CPU-only (2 CPU, 3Gi RAM)
# - Smaller model cache (5Gi vs 10Gi)
# - Reduced library storage (50Gi default)
# - Suitable for personal/family use (1-5 users)
#
# Usage:
#   helm install immich ./charts/immich \
#     -f charts/immich/values-homeserver.yaml \
#     --set postgresql.external.host=postgres.default.svc.cluster.local \
#     --set postgresql.external.password=your-db-password \
#     --set redis.external.host=redis.default.svc.cluster.local

# ========================================
# Immich Services Configuration
# ========================================
immich:
  # Server configuration - reduced resources
  server:
    enabled: true
    replicaCount: 1
    image:
      repository: ghcr.io/immich-app/immich-server
      pullPolicy: IfNotPresent
      tag: ""  # Uses chart appVersion

    resources:
      limits:
        cpu: 1000m      # 1 CPU (vs 2 CPU default)
        memory: 1.5Gi   # 1.5GB RAM (vs 2Gi default)
      requests:
        cpu: 250m       # 0.25 CPU
        memory: 512Mi   # 512MB RAM

  # Machine Learning service - CPU-only optimization
  machineLearning:
    enabled: true
    replicaCount: 1
    image:
      repository: ghcr.io/immich-app/immich-machine-learning
      pullPolicy: IfNotPresent
      tag: ""

    # CPU-only for home servers (no GPU acceleration)
    acceleration: "none"
    # Options for hardware acceleration if available:
    # - "openvino" for Intel integrated GPU
    # - "armnn" for Raspberry Pi GPU
    # - "cuda" for NVIDIA GPU
    # - "rocm" for AMD GPU

    resources:
      limits:
        cpu: 2000m      # 2 CPU (vs 4 CPU default)
        memory: 3Gi     # 3GB RAM (vs 4Gi default)
      requests:
        cpu: 500m       # 0.5 CPU
        memory: 1Gi     # 1GB RAM

    # Model cache - reduced for home servers
    modelCache:
      enabled: true
      storageClass: ""
      size: 5Gi         # 5GB (vs 10Gi default)
      accessMode: ReadWriteOnce

  # Environment configuration
  env:
    # Timezone - adjust to your location
    TZ: "UTC"  # Change to your timezone, e.g., "America/New_York"

    # Logging
    LOG_LEVEL: "log"  # Use "warn" to reduce log verbosity on low-power servers

    # Upload configuration
    IMMICH_MEDIA_LOCATION: "/data"

# ========================================
# External Dependencies
# ========================================

# PostgreSQL (REQUIRED)
# Must have pgvecto.rs extension installed
postgresql:
  enabled: false
  external:
    enabled: true
    host: ""  # Set to your PostgreSQL service
    port: 5432
    database: "immich"
    username: "immich"
    password: ""  # Required
    sslmode: "disable"

# Redis (REQUIRED)
redis:
  enabled: false
  external:
    enabled: true
    host: ""  # Set to your Redis service
    port: 6379
    password: ""
    database: 0

# ========================================
# Persistence
# ========================================
persistence:
  enabled: true

  # Photo/video library storage - reduced for home use
  library:
    enabled: true
    storageClass: ""  # Use default or "local-path" for k3s
    accessMode: ReadWriteOnce
    size: 50Gi        # 50GB (vs 100Gi default)
    mountPath: /data
    existingClaim: ""
    reclaimPolicy: Retain  # Important: Prevent data loss

# ========================================
# Service Configuration
# ========================================
service:
  type: ClusterIP
  port: 2283
  targetPort: 2283
  annotations: {}

# ========================================
# Ingress Configuration
# ========================================

# Ingress - disabled by default for home servers
ingress:
  enabled: false
  className: "nginx"
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "2G"  # Reduced for home use
    nginx.ingress.kubernetes.io/proxy-buffering: "off"
    nginx.ingress.kubernetes.io/proxy-request-buffering: "off"
  hosts:
    - host: immich.local
      paths:
        - path: /
          pathType: Prefix
  tls: []

# ========================================
# Resource Management
# ========================================

# No autoscaling for home servers
autoscaling:
  enabled: false

# No PodDisruptionBudget for single replica
podDisruptionBudget:
  enabled: false

# No NetworkPolicy for home networks
networkPolicy:
  enabled: false

# ========================================
# Deployment Settings
# ========================================

# Service account
serviceAccount:
  create: true
  automount: true
  annotations: {}
  name: ""

podAnnotations: {}
podLabels: {}

# Security context
podSecurityContext:
  fsGroup: 1000

securityContext:
  runAsUser: 1000
  runAsGroup: 1000
  runAsNonRoot: true
  readOnlyRootFilesystem: false

# ========================================
# Health Checks
# ========================================

# Liveness probe - relaxed for low-power servers
livenessProbe:
  httpGet:
    path: /api/server-info/ping
    port: http
  initialDelaySeconds: 60   # Wait longer for ML model loading
  periodSeconds: 30
  timeoutSeconds: 10
  failureThreshold: 5
  successThreshold: 1

# Readiness probe
readinessProbe:
  httpGet:
    path: /api/server-info/ping
    port: http
  initialDelaySeconds: 30
  periodSeconds: 15
  timeoutSeconds: 5
  failureThreshold: 3
  successThreshold: 1

# Startup probe - extended for ML initialization
startupProbe:
  httpGet:
    path: /api/server-info/ping
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 60      # Allow up to 10 minutes for ML models
  successThreshold: 1

# ========================================
# Node Selection
# ========================================

nodeSelector: {}
# Example for Raspberry Pi:
# nodeSelector:
#   kubernetes.io/arch: arm64

tolerations: []

affinity: {}

# ========================================
# Monitoring
# ========================================

# Monitoring disabled by default for home servers
monitoring:
  enabled: false
  serviceMonitor:
    enabled: false

metrics:
  enabled: false

# ========================================
# Notes for Home Server Users
# ========================================

# Post-installation checklist:
#
# 1. PostgreSQL Setup:
#    - Install pgvecto.rs extension (REQUIRED for ML features)
#    - CREATE EXTENSION IF NOT EXISTS vectors;
#
# 2. Access Immich:
#    kubectl port-forward svc/immich 2283:2283
#    Open http://localhost:2283
#
# 3. Initial Setup:
#    - Create admin account on first login
#    - Configure timezone in Server Settings
#    - Enable/disable ML features based on server capacity
#
# 4. ML Feature Recommendations for Home Servers:
#    - Smart Search: Enable (CPU-intensive but very useful)
#    - Face Detection: Enable (runs once per photo)
#    - Object Detection: Optional (CPU-intensive)
#    - CLIP Encoding: Enable (for semantic search)
#
# 5. Performance Tips:
#    - Schedule ML jobs during off-peak hours
#    - Process photos in batches (Settings > Job Settings)
#    - Consider disabling some ML features if server is slow
#    - Use SSD storage for library if possible
#
# 6. Hardware Acceleration (Optional):
#    For Intel integrated GPU (NUC, modern CPUs):
#      machineLearning.acceleration: "openvino"
#    For Raspberry Pi GPU:
#      machineLearning.acceleration: "armnn"
#
# 7. Backup Strategy:
#    - Enable persistence.library.reclaimPolicy: Retain
#    - Regular database backups (PostgreSQL dumps)
#    - Consider backing up model cache to avoid re-download
#
# 8. Mobile App Setup:
#    - Server URL: http://<your-ip>:2283 or https://immich.yourdomain.com
#    - Enable mobile upload in app settings
#    - Configure background upload (WiFi only recommended)
#
# 9. Storage Estimates:
#    - 50GB: ~25,000 photos (2MB average)
#    - 100GB: ~50,000 photos
#    - Add 10-20% overhead for thumbnails and ML data
#    - Model cache: ~5GB for standard models
#
# 10. Troubleshooting:
#     - If ML jobs fail: Increase machineLearning.resources.memory
#     - If uploads are slow: Check network and storage performance
#     - If face detection is slow: It's normal, runs in background
#     - Check logs: kubectl logs -f deployment/immich-server
