# Immich Helm Chart - Default Values
#
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# ========================================
# 1. Immich Services Configuration
# ========================================
immich:
  # Server configuration
  server:
    enabled: true
    replicaCount: 1
    image:
      repository: ghcr.io/immich-app/immich-server
      pullPolicy: IfNotPresent
      tag: ""  # Uses chart appVersion

    resources:
      limits:
        cpu: 2000m
        memory: 2Gi
      requests:
        cpu: 500m
        memory: 1Gi

  # Machine Learning service
  machineLearning:
    enabled: true
    replicaCount: 1
    image:
      repository: ghcr.io/immich-app/immich-machine-learning
      pullPolicy: IfNotPresent
      tag: ""  # Uses chart appVersion

    # Hardware acceleration
    # Options: none, cuda, rocm, openvino, armnn, rknn
    acceleration: "none"

    resources:
      limits:
        cpu: 4000m
        memory: 4Gi
      requests:
        cpu: 1000m
        memory: 2Gi

    # Model cache persistence
    modelCache:
      enabled: true
      storageClass: ""
      size: 10Gi
      accessMode: ReadWriteOnce

  # Environment configuration
  env:
    # Timezone (REQUIRED)
    TZ: "UTC"

    # Server configuration
    LOG_LEVEL: "log"  # verbose, debug, log, warn, error

    # Upload configuration
    IMMICH_MEDIA_LOCATION: "/data"

# ========================================
# 2. External Dependencies
# ========================================

# PostgreSQL (REQUIRED)
postgresql:
  enabled: false  # Set to true if using external PostgreSQL
  external:
    enabled: true
    host: ""  # REQUIRED
    port: 5432
    database: "immich"
    username: "immich"
    password: ""  # REQUIRED
    # PostgreSQL must have pgvecto.rs extension installed
    sslmode: "disable"  # disable, allow, prefer, require, verify-ca, verify-full

# Redis (REQUIRED)
redis:
  enabled: false  # Set to true if using external Redis
  external:
    enabled: true
    host: ""  # REQUIRED
    port: 6379
    password: ""  # Optional
    database: 0

# ========================================
# 3. Persistence
# ========================================
persistence:
  enabled: true

  # Upload storage (photos, videos, profile pictures)
  library:
    enabled: true
    storageClass: ""
    accessMode: ReadWriteOnce
    size: 100Gi  # Adjust based on photo library size
    mountPath: /data
    existingClaim: ""
    reclaimPolicy: Retain

# ========================================
# 4. Service Configuration
# ========================================
service:
  type: ClusterIP
  port: 2283
  targetPort: 2283
  annotations: {}

# ========================================
# 5. Ingress Configuration
# ========================================
ingress:
  enabled: false
  className: ""
  annotations: {}
    # nginx.ingress.kubernetes.io/proxy-body-size: "0"
    # nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
    # nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
    # cert-manager.io/cluster-issuer: "letsencrypt-prod"
  hosts:
    - host: immich.example.com
      paths:
        - path: /
          pathType: Prefix
  tls: []
  #  - secretName: immich-tls
  #    hosts:
  #      - immich.example.com

# ========================================
# 6. Service Account
# ========================================
serviceAccount:
  create: true
  automount: true
  annotations: {}
  name: ""

# ========================================
# 6a. RBAC Configuration
# ========================================
rbac:
  # Specifies whether RBAC resources should be created
  create: true
  # Annotations to add to the Role and RoleBinding
  annotations: {}

# ========================================
# 7. Pod Configuration
# ========================================
podAnnotations: {}
podLabels: {}

podSecurityContext:
  fsGroup: 1000
  runAsUser: 1000
  runAsGroup: 1000
  runAsNonRoot: true

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: false  # Immich needs write access

# ========================================
# 8. Health Probes
# ========================================
livenessProbe:
  enabled: true
  httpGet:
    path: /api/server-info/ping
    port: http
  initialDelaySeconds: 60
  periodSeconds: 30
  timeoutSeconds: 10
  failureThreshold: 6

readinessProbe:
  enabled: true
  httpGet:
    path: /api/server-info/ping
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 10
  failureThreshold: 3

startupProbe:
  enabled: true
  httpGet:
    path: /api/server-info/ping
    port: http
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 10
  failureThreshold: 60

# ========================================
# 9. Autoscaling (Server only)
# ========================================
autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 5
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 80

# ========================================
# 10. Pod Disruption Budget
# ========================================
podDisruptionBudget:
  enabled: false
  minAvailable: 1
  # maxUnavailable: 1

# ========================================
# 11. Network Policy
# ========================================
networkPolicy:
  enabled: false
  ingress: []
  egress: []

# ========================================
# 12. Scheduling
# ========================================
nodeSelector: {}

tolerations: []

affinity: {}

# ========================================
# 13. Image Pull Secrets
# ========================================
imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

# ========================================
# 14. Backup & Recovery Configuration
# ========================================
# NOTE: This is DOCUMENTATION ONLY - backups are performed via Makefile targets
# The chart does NOT create automated backup CronJobs
# See docs/immich-backup-guide.md for detailed procedures
backup:
  # Documentation flag - does not enable automated backups
  enabled: false

  # Backup strategy overview
  documentation:
    # Backup components (5 layers)
    strategy: "Library PVC + PostgreSQL Database + Redis Cache + ML Model Cache + Configuration"

    # Backup tools/methods
    tools:
      - "tar/Restic for library PVC"
      - "pg_dump for PostgreSQL"
      - "VolumeSnapshot API for PVC snapshots"
      - "redis-cli BGSAVE for Redis"

    # Components to backup
    components:
      library:
        description: "Photos, videos, profile pictures, thumbnails"
        location: "Library PVC (/data)"
        size: "Large (100GB - 5TB)"
        method: "tar, Restic (incremental recommended)"
        priority: "Critical"
      database:
        description: "Photo metadata, albums, sharing, users, ML embeddings"
        location: "External PostgreSQL"
        size: "Medium (1-10GB)"
        method: "pg_dump (custom format)"
        priority: "Critical"
      redisCache:
        description: "Session cache, job queues"
        location: "External Redis"
        size: "Small (< 100MB)"
        method: "RDB snapshot"
        priority: "Low (can rebuild)"
      mlCache:
        description: "Downloaded ML models (face recognition, CLIP)"
        location: "ML Cache PVC (/cache)"
        size: "Medium (~10GB)"
        method: "tar"
        priority: "Medium (can re-download)"
      configuration:
        description: "Helm values, ConfigMaps, Secrets"
        location: "Kubernetes resources"
        size: "Small (< 1MB)"
        method: "helm get values, kubectl get"
        priority: "High"

    # Recovery targets
    targets:
      rto: "< 2 hours"  # Recovery Time Objective
      rpo: "24 hours"   # Recovery Point Objective (with daily backups)

  # Makefile commands (for documentation)
  commands:
    fullBackup: "make -f make/ops/immich.mk immich-full-backup"
    incrementalBackup: "make -f make/ops/immich.mk immich-backup-library-restic"
    snapshotBackup: "make -f make/ops/immich.mk immich-snapshot-library"
    restoreDatabase: "make -f make/ops/immich.mk immich-restore-db BACKUP_FILE=/path/to/backup"
    restoreLibrary: "make -f make/ops/immich.mk immich-restore-library BACKUP_FILE=/path/to/backup"
    verifyBackup: "make -f make/ops/immich.mk immich-verify-backup BACKUP_FILE=/path/to/backup"

# ========================================
# 15. Upgrade Configuration
# ========================================
# NOTE: This is DOCUMENTATION ONLY - upgrades are manual processes
# The chart does NOT perform automatic upgrades
# See docs/immich-upgrade-guide.md for detailed procedures
upgrade:
  # Documentation flag - does not enable automated upgrades
  enabled: false

  # Upgrade strategy documentation
  documentation:
    # Available upgrade strategies
    strategies:
      rolling:
        description: "Zero-downtime upgrade with gradual pod replacement"
        downtime: "None"
        risk: "Low to Medium"
        bestFor: "Patch and minor version upgrades (v1.119.x → v1.120.x)"
      blueGreen:
        description: "Parallel deployment with traffic cutover"
        downtime: "10-30 minutes (cutover)"
        risk: "Low"
        bestFor: "Major version upgrades (v1.x → v2.x)"
      maintenanceWindow:
        description: "Full cluster restart during scheduled downtime"
        downtime: "30 minutes - 2 hours"
        risk: "Medium to High"
        bestFor: "Major upgrades with breaking changes"

    # Pre-upgrade requirements
    preUpgrade:
      - "Full backup (MANDATORY)"
      - "Review Immich release notes"
      - "Test in staging environment"
      - "Plan rollback strategy"
      - "Schedule maintenance window (if needed)"

    # Post-upgrade validation
    postUpgrade:
      - "Verify all pods running"
      - "Check image versions"
      - "Test database connectivity"
      - "Verify photo count"
      - "Test web interface"
      - "Check ML functionality"

  # Makefile commands (for documentation)
  commands:
    preUpgradeCheck: "make -f make/ops/immich.mk immich-pre-upgrade-check"
    rollingUpgrade: "make -f make/ops/immich.mk immich-rolling-upgrade VERSION=v1.120.0"
    postUpgradeCheck: "make -f make/ops/immich.mk immich-post-upgrade-check"
    rollback: "make -f make/ops/immich.mk immich-upgrade-rollback"

# ========================================
# 16. Monitoring (Optional)
# ========================================
# NOTE: Immich does not natively expose Prometheus metrics
# Consider using a third-party exporter if monitoring is required
monitoring:
  enabled: false
  serviceMonitor:
    enabled: false
    interval: 30s
    scrapeTimeout: 10s
