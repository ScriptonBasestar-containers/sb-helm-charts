# Immich Helm Chart - Default Values
#
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# ========================================
# 1. Immich Services Configuration
# ========================================
immich:
  # Server configuration
  server:
    enabled: true
    replicaCount: 1
    image:
      repository: ghcr.io/immich-app/immich-server
      pullPolicy: IfNotPresent
      tag: ""  # Uses chart appVersion

    resources:
      limits:
        cpu: 2000m
        memory: 2Gi
      requests:
        cpu: 500m
        memory: 1Gi

  # Machine Learning service
  machineLearning:
    enabled: true
    replicaCount: 1
    image:
      repository: ghcr.io/immich-app/immich-machine-learning
      pullPolicy: IfNotPresent
      tag: ""  # Uses chart appVersion

    # Hardware acceleration
    # Options: none, cuda, rocm, openvino, armnn, rknn
    acceleration: "none"

    resources:
      limits:
        cpu: 4000m
        memory: 4Gi
      requests:
        cpu: 1000m
        memory: 2Gi

    # Model cache persistence
    modelCache:
      enabled: true
      storageClass: ""
      size: 10Gi
      accessMode: ReadWriteOnce

  # Environment configuration
  env:
    # Timezone (REQUIRED)
    TZ: "UTC"

    # Server configuration
    LOG_LEVEL: "log"  # verbose, debug, log, warn, error

    # Upload configuration
    IMMICH_MEDIA_LOCATION: "/data"

# ========================================
# 2. External Dependencies
# ========================================

# PostgreSQL (REQUIRED)
postgresql:
  enabled: false  # Set to true if using external PostgreSQL
  external:
    enabled: true
    host: ""  # REQUIRED
    port: 5432
    database: "immich"
    username: "immich"
    password: ""  # REQUIRED
    # PostgreSQL must have pgvecto.rs extension installed
    sslmode: "disable"  # disable, allow, prefer, require, verify-ca, verify-full

# Redis (REQUIRED)
redis:
  enabled: false  # Set to true if using external Redis
  external:
    enabled: true
    host: ""  # REQUIRED
    port: 6379
    password: ""  # Optional
    database: 0

# ========================================
# 3. Persistence
# ========================================
persistence:
  enabled: true

  # Upload storage (photos, videos, profile pictures)
  library:
    enabled: true
    storageClass: ""
    accessMode: ReadWriteOnce
    size: 100Gi  # Adjust based on photo library size
    mountPath: /data
    existingClaim: ""
    reclaimPolicy: Retain

# ========================================
# 4. Service Configuration
# ========================================
service:
  type: ClusterIP
  port: 2283
  targetPort: 2283
  annotations: {}

# ========================================
# 5. Ingress Configuration
# ========================================
ingress:
  enabled: false
  className: ""
  annotations: {}
    # nginx.ingress.kubernetes.io/proxy-body-size: "0"
    # nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
    # nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
    # cert-manager.io/cluster-issuer: "letsencrypt-prod"
  hosts:
    - host: immich.example.com
      paths:
        - path: /
          pathType: Prefix
  tls: []
  #  - secretName: immich-tls
  #    hosts:
  #      - immich.example.com

# ========================================
# 6. Service Account
# ========================================
serviceAccount:
  create: true
  automount: true
  annotations: {}
  name: ""

# ========================================
# 6a. RBAC Configuration
# ========================================
rbac:
  # Specifies whether RBAC resources should be created
  create: true
  # Annotations to add to the Role and RoleBinding
  annotations: {}

# ========================================
# 7. Pod Configuration
# ========================================
podAnnotations: {}
podLabels: {}

podSecurityContext:
  fsGroup: 1000
  runAsUser: 1000
  runAsGroup: 1000
  runAsNonRoot: true

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: false  # Immich needs write access

# ========================================
# 8. Health Probes
# ========================================
livenessProbe:
  enabled: true
  httpGet:
    path: /api/server-info/ping
    port: http
  initialDelaySeconds: 60
  periodSeconds: 30
  timeoutSeconds: 10
  failureThreshold: 6

readinessProbe:
  enabled: true
  httpGet:
    path: /api/server-info/ping
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 10
  failureThreshold: 3

startupProbe:
  enabled: true
  httpGet:
    path: /api/server-info/ping
    port: http
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 10
  failureThreshold: 60

# ========================================
# 9. Autoscaling (Server only)
# ========================================
autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 5
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 80

# ========================================
# 10. Pod Disruption Budget
# ========================================
podDisruptionBudget:
  enabled: false
  minAvailable: 1
  # maxUnavailable: 1

# ========================================
# 11. Network Policy
# ========================================
networkPolicy:
  enabled: false
  ingress: []
  egress: []

# ========================================
# 12. Scheduling
# ========================================
nodeSelector: {}

tolerations: []

affinity: {}

# ========================================
# 13. Image Pull Secrets
# ========================================
imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

# ========================================
# 14. Monitoring (Optional)
# ========================================
# NOTE: Immich does not natively expose Prometheus metrics
# Consider using a third-party exporter if monitoring is required
monitoring:
  enabled: false
  serviceMonitor:
    enabled: false
    interval: 30s
    scrapeTimeout: 10s
