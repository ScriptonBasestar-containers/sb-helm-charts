# Default values for devpi.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# 1. Application-specific Configuration
devpi:
  # Devpi server root password (required)
  # This is the password for the root user
  rootPassword: ""

  # Use existing secret for root password
  existingSecret: ""
  secretKeyName: "devpi-root-password"

  # Server host configuration
  # External URL for the devpi server (used in package URLs)
  serverUrl: ""

  # Port to bind (default: 3141)
  port: 3141

  # PyPI mirror configuration
  mirror:
    enabled: true
    # URL of the PyPI mirror to use
    indexUrl: "https://pypi.org/simple"
    # Cache expiry time
    cacheExpiry: 3600

  # Initial users to create (optional)
  # Format: username:password
  initialUsers: []
  # Example:
  # initialUsers:
  #   - "user1:password1"
  #   - "user2:password2"

  # Initial indexes to create (optional)
  initialIndexes: []
  # Example:
  # initialIndexes:
  #   - "dev/testing"
  #   - "prod/stable"

# 2. External Dependencies
postgresql:
  enabled: false
  # Devpi can optionally use PostgreSQL instead of SQLite
  external:
    enabled: false
    host: ""
    port: 5432
    database: "devpi"
    username: "devpi"
    password: ""

mysql:
  enabled: false

redis:
  enabled: false

# 3. Persistence Configuration
persistence:
  enabled: true
  storageClass: ""
  size: 8Gi
  accessMode: ReadWriteOnce
  existingClaim: ""
  reclaimPolicy: Retain
  mountPath: /devpi/server

# 4. Kubernetes Resources
replicaCount: 1

strategy:
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 1
    maxUnavailable: 0

image:
  repository: jonasal/devpi-server
  tag: "6.17.0-alpine"
  pullPolicy: IfNotPresent

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

# 5. Service Account
serviceAccount:
  create: true
  automount: true
  annotations: {}
  name: ""

# 6. Pod Configuration
podAnnotations: {}
podLabels: {}

podSecurityContext:
  fsGroup: 1000
  runAsUser: 1000
  runAsGroup: 1000
  runAsNonRoot: true

securityContext:
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: false  # Devpi needs to write to /tmp
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  allowPrivilegeEscalation: false

# 7. Service Configuration
service:
  type: ClusterIP
  port: 3141
  targetPort: 3141
  protocol: TCP
  annotations: {}

# 8. Ingress Configuration
ingress:
  enabled: false
  className: ""
  annotations: {}
    # kubernetes.io/ingress.class: nginx
    # kubernetes.io/tls-acme: "true"
  hosts:
    - host: devpi.local
      paths:
        - path: /
          pathType: Prefix
  tls: []
  #  - secretName: devpi-tls
  #    hosts:
  #      - devpi.local

# 9. Resources
resources:
  # IMPORTANT: jonasal/devpi-server requires minimum 512Mi memory
  # Initial PyPI indexing is memory-intensive
  limits:
    cpu: 1000m
    memory: 1Gi
  requests:
    cpu: 100m
    memory: 512Mi

# 10. Health Probes
livenessProbe:
  enabled: true
  httpGet:
    path: /
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 6
  successThreshold: 1

readinessProbe:
  enabled: true
  httpGet:
    path: /
    port: http
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3
  successThreshold: 1

startupProbe:
  enabled: true
  httpGet:
    path: /
    port: http
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 30
  successThreshold: 1

# 11. Autoscaling
autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 5
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 80

# 12. Pod Disruption Budget
podDisruptionBudget:
  enabled: false
  minAvailable: 1
  # maxUnavailable: 1

# 13. Network Policy
networkPolicy:
  enabled: false
  ingress:
    - from:
        - podSelector: {}
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 3141
  egress:
    - to:
        - podSelector: {}

# 14. Monitoring
monitoring:
  enabled: false
  serviceMonitor:
    enabled: false
    interval: 30s
    scrapeTimeout: 10s
    labels: {}
    path: /

# 15. Scheduling
nodeSelector: {}
tolerations: []
affinity: {}
priorityClassName: ""
topologySpreadConstraints: []

# 16. Extensibility
extraEnv: []
# Example:
# extraEnv:
#   - name: DEVPI_SERVERDIR
#     value: "/data"

extraEnvFrom: []

extraVolumes: []
# Example:
# extraVolumes:
#   - name: custom-config
#     configMap:
#       name: devpi-config

extraVolumeMounts: []
# Example:
# extraVolumeMounts:
#   - name: custom-config
#     mountPath: /etc/devpi
#     readOnly: true

initContainers: []
# Example: Database health check
# initContainers:
#   - name: wait-for-db
#     image: postgres:16-alpine
#     command: ['sh', '-c', 'until pg_isready -h $DB_HOST; do sleep 2; done']

lifecycle: {}
# Example:
# lifecycle:
#   preStop:
#     exec:
#       command: ["/bin/sh", "-c", "sleep 15"]
