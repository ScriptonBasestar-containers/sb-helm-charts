apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "airflow.configMapName" . }}
  labels:
    {{- include "airflow.labels" . | nindent 4 }}
data:
  airflow.cfg: |
    [core]
    dags_folder = /opt/airflow/dags
    executor = {{ .Values.airflow.executor }}
    load_examples = {{ .Values.airflow.loadExamples }}
    load_default_connections = {{ .Values.airflow.loadDefaultConnections }}
    parallelism = {{ .Values.airflow.parallelism }}
    max_active_tasks_per_dag = {{ .Values.airflow.maxActiveTasksPerDag }}
    max_active_runs_per_dag = {{ .Values.airflow.maxActiveRunsPerDag }}

    [database]
    sql_alchemy_conn = $AIRFLOW__DATABASE__SQL_ALCHEMY_CONN

    [webserver]
    base_url = {{ include "airflow.webserver.url" . }}
    web_server_port = 8080
    expose_config = {{ .Values.airflow.exposeConfig }}
    enable_proxy_fix = {{ .Values.airflow.enableProxyFix }}

    [scheduler]
    scheduler_heartbeat_sec = {{ .Values.airflow.schedulerHeartbeatSec }}

    [logging]
    base_log_folder = /opt/airflow/logs
    remote_logging = {{ .Values.airflow.remoteLogging.enabled }}
    {{- if .Values.airflow.remoteLogging.enabled }}
    remote_base_log_folder = {{ .Values.airflow.remoteLogging.remoteBaseLogFolder }}
    remote_log_conn_id = {{ .Values.airflow.remoteLogging.remoteLogConnId }}
    {{- end }}

    [api]
    auth_backends = airflow.api.auth.backend.basic_auth

    {{- if .Values.airflow.config }}
    {{- range $key, $value := .Values.airflow.config }}
    {{ $key }} = {{ $value }}
    {{- end }}
    {{- end }}
