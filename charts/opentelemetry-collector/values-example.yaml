# Production configuration with Prometheus/Mimir, Loki, and Tempo backends
# This example demonstrates a complete observability pipeline

replicaCount: 2

config:
  receivers:
    otlp:
      protocols:
        grpc:
          endpoint: 0.0.0.0:4317
        http:
          endpoint: 0.0.0.0:4318
          cors:
            allowed_origins:
              - "*"

    # Optional: Prometheus scraping
    # prometheus:
    #   config:
    #     scrape_configs:
    #       - job_name: 'otel-collector'
    #         scrape_interval: 10s
    #         static_configs:
    #           - targets: ['localhost:8888']

  processors:
    batch:
      timeout: 5s
      send_batch_size: 10000
      send_batch_max_size: 11000

    memory_limiter:
      check_interval: 1s
      limit_percentage: 80
      spike_limit_percentage: 25

    # Kubernetes attributes processor
    k8sattributes:
      auth_type: "serviceAccount"
      passthrough: false
      extract:
        metadata:
          - k8s.namespace.name
          - k8s.deployment.name
          - k8s.statefulset.name
          - k8s.daemonset.name
          - k8s.cronjob.name
          - k8s.job.name
          - k8s.node.name
          - k8s.pod.name
          - k8s.pod.uid
          - k8s.pod.start_time
        labels:
          - tag_name: app
            key: app.kubernetes.io/name
            from: pod
          - tag_name: version
            key: app.kubernetes.io/version
            from: pod
      pod_association:
        - sources:
            - from: resource_attribute
              name: k8s.pod.ip
        - sources:
            - from: resource_attribute
              name: k8s.pod.uid
        - sources:
            - from: connection

    # Resource detection
    resourcedetection:
      detectors:
        - env
        - system
        - k8snode
      timeout: 5s
      override: false

  exporters:
    # Debug exporter for development
    debug:
      verbosity: basic

    # Prometheus Remote Write (for Mimir/Prometheus)
    prometheusremotewrite:
      endpoint: http://mimir.monitoring.svc.cluster.local:8080/api/v1/push
      tls:
        insecure: true
      resource_to_telemetry_conversion:
        enabled: true

    # OTLP exporter for Tempo (traces)
    otlp/tempo:
      endpoint: tempo.monitoring.svc.cluster.local:4317
      tls:
        insecure: true

    # Loki exporter (logs)
    loki:
      endpoint: http://loki.monitoring.svc.cluster.local:3100/loki/api/v1/push
      labels:
        attributes:
          k8s.namespace.name: "namespace"
          k8s.pod.name: "pod"
          k8s.container.name: "container"
        resource:
          k8s.cluster.name: "cluster"
          k8s.node.name: "node"

  extensions:
    health_check:
      endpoint: 0.0.0.0:13133
    zpages:
      endpoint: 0.0.0.0:55679

  service:
    extensions:
      - health_check
      - zpages
    pipelines:
      traces:
        receivers:
          - otlp
        processors:
          - memory_limiter
          - k8sattributes
          - resourcedetection
          - batch
        exporters:
          - otlp/tempo

      metrics:
        receivers:
          - otlp
        processors:
          - memory_limiter
          - resourcedetection
          - batch
        exporters:
          - prometheusremotewrite

      logs:
        receivers:
          - otlp
        processors:
          - memory_limiter
          - k8sattributes
          - resourcedetection
          - batch
        exporters:
          - loki

    telemetry:
      logs:
        level: info
      metrics:
        address: 0.0.0.0:8888

# RBAC for k8sattributes processor
rbac:
  create: true
  clusterRole: true

# Production resources
resources:
  limits:
    cpu: 2000m
    memory: 4Gi
  requests:
    cpu: 500m
    memory: 1Gi

# Enable ServiceMonitor
serviceMonitor:
  enabled: true
  labels:
    release: prometheus

# Enable PDB for HA
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Enable autoscaling
autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 5
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# Anti-affinity for HA
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - opentelemetry-collector
          topologyKey: kubernetes.io/hostname
