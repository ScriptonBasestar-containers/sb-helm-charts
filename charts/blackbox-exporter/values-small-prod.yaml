# Small production values for blackbox-exporter
# This configuration is optimized for production deployments

image:
  repository: prom/blackbox-exporter
  pullPolicy: IfNotPresent
  tag: ""

# Production: 2 replicas for reliability
replicaCount: 2

serviceAccount:
  create: true

podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "9115"

podSecurityContext:
  runAsUser: 65534
  runAsNonRoot: true
  fsGroup: 65534

securityContext:
  readOnlyRootFilesystem: true
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL

service:
  type: ClusterIP
  port: 9115
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9115"

# Production: Comprehensive probe modules
config:
  modules:
    # HTTP probes
    http_2xx:
      prober: http
      timeout: 5s
      http:
        valid_http_versions: ["HTTP/1.1", "HTTP/2.0"]
        valid_status_codes: []
        method: GET
        preferred_ip_protocol: "ip4"
        follow_redirects: true
        fail_if_ssl: false
        fail_if_not_ssl: false

    http_post_2xx:
      prober: http
      timeout: 5s
      http:
        method: POST
        headers:
          Content-Type: application/json
        body: '{}'

    # HTTPS with SSL verification
    https_2xx:
      prober: http
      timeout: 10s
      http:
        valid_http_versions: ["HTTP/1.1", "HTTP/2.0"]
        method: GET
        tls_config:
          insecure_skip_verify: false
        preferred_ip_protocol: "ip4"
        follow_redirects: true

    # HTTPS with custom headers
    https_2xx_custom:
      prober: http
      timeout: 10s
      http:
        method: GET
        headers:
          User-Agent: "Blackbox-Exporter/Production"
        tls_config:
          insecure_skip_verify: false

    # TCP probes
    tcp_connect:
      prober: tcp
      timeout: 5s

    # ICMP probe
    icmp:
      prober: icmp
      timeout: 5s
      icmp:
        preferred_ip_protocol: "ip4"

    # DNS probes
    dns_udp:
      prober: dns
      timeout: 5s
      dns:
        transport_protocol: "udp"
        preferred_ip_protocol: "ip4"
        query_name: "example.com"
        query_type: "A"

    dns_tcp:
      prober: dns
      timeout: 5s
      dns:
        transport_protocol: "tcp"
        preferred_ip_protocol: "ip4"
        query_name: "example.com"
        query_type: "A"

    # SSH probe
    ssh_banner:
      prober: tcp
      timeout: 5s
      tcp:
        query_response:
          - expect: "^SSH-2.0-"

    # SMTP probe
    smtp_starttls:
      prober: tcp
      timeout: 10s
      tcp:
        query_response:
          - expect: "^220 "
          - send: "EHLO blackbox-exporter"
          - expect: "^250-STARTTLS"
          - send: "STARTTLS"
          - expect: "^220 "
          - starttls: true
          - send: "QUIT"

extraArgs:
  - --log.level=info
  - --history.limit=100

# ServiceMonitor for Prometheus Operator
serviceMonitor:
  enabled: true
  interval: 60s
  scrapeTimeout: 30s
  labels:
    prometheus: kube-prometheus

# Production resources
resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 128Mi

livenessProbe:
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 3
  failureThreshold: 5

readinessProbe:
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 3
  failureThreshold: 3

nodeSelector: {}

# Tolerate all taints for critical monitoring infrastructure
tolerations:
  - effect: NoSchedule
    operator: Exists

# Anti-affinity to spread replicas across nodes
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                  - blackbox-exporter
          topologyKey: kubernetes.io/hostname

# Use high priority for critical monitoring
priorityClassName: "system-cluster-critical"
