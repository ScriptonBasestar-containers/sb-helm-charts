# Vaultwarden Helm Chart - Home Server Configuration
#
# Optimized for:
# - Raspberry Pi 4 (4GB+)
# - Intel NUC / Mini PC
# - Small home servers
# - Personal/family use (1-10 users)
#
# Features:
# - SQLite database (embedded, no external DB required)
# - Reduced resource allocation (256Mi RAM limit)
# - StatefulSet with persistent storage
# - Local network access (ClusterIP service)
# - Suitable for personal vaults and family password sharing

# ========================================
# Vaultwarden Configuration
# ========================================
vaultwarden:
  # Domain URL - for local network access, use http://vault.local or IP
  # For internet access, use your home domain with HTTPS (e.g., DuckDNS + Let's Encrypt)
  domain: ""  # Set to "http://vault.local" or your home domain

  # Admin panel configuration
  admin:
    enabled: true
    token: ""  # Will generate random token
    disableAdminToken: false

  # SMTP configuration (optional for home use)
  smtp:
    enabled: false
    # Example: Gmail SMTP (uncomment to use)
    # host: "smtp.gmail.com"
    # port: 587
    # security: "starttls"
    # username: "your-email@gmail.com"
    # password: ""  # Use app-specific password
    # from: "your-email@gmail.com"

  # Sign-up configuration
  signups:
    allowed: true  # Allow family members to register
    verifySignup: false  # No email verification needed for local use
    allowedDomains: ""  # No domain restriction for home use
    allowInvitations: true

  # Security settings
  security:
    require2FA: false  # Optional for home use, recommended to enable
    showPasswordHint: true
    websocketEnabled: true
    iconService: "internal"
    disableIconDownload: false

  # Attachment configuration
  attachments:
    maxSize: 10  # 10MB max (reduce for low-storage devices)

  # Send configuration
  sends:
    enabled: true
    hideEmail: true

  # Performance tuning (0 = auto-detect)
  workers: 0

# ========================================
# External Dependencies
# ========================================
# Use SQLite for simplicity (no external database needed)
sqlite:
  enabled: true

postgresql:
  enabled: false

mysql:
  enabled: false

# ========================================
# Persistence
# ========================================
persistence:
  enabled: true

  # Data directory (SQLite database + attachments)
  data:
    enabled: true
    storageClass: ""  # Use default storage class
    accessMode: ReadWriteOnce
    size: 5Gi  # 5GB for personal use (adjust based on family size)
    mountPath: /data
    reclaimPolicy: Retain

# ========================================
# Deployment Mode (auto = StatefulSet for SQLite)
# ========================================
workloadType: "auto"

# ========================================
# Basic Kubernetes Configuration
# ========================================
replicaCount: 1

image:
  repository: vaultwarden/server
  pullPolicy: IfNotPresent
  tag: ""

# ========================================
# Service Configuration
# ========================================
service:
  type: ClusterIP  # Use NodePort or LoadBalancer for direct access
  ports:
    - name: http
      port: 80
      targetPort: 80
      protocol: TCP
    - name: websocket
      port: 3012
      targetPort: 3012
      protocol: TCP

# ========================================
# Ingress Configuration (Disabled by default)
# ========================================
ingress:
  enabled: false
  # Enable for internet access with reverse proxy:
  # className: "nginx"
  # annotations:
  #   cert-manager.io/cluster-issuer: letsencrypt-prod
  # hosts:
  #   - host: vault.home.duckdns.org
  #     paths:
  #       - path: /
  #         pathType: Prefix
  # tls:
  #   - secretName: vaultwarden-tls
  #     hosts:
  #       - vault.home.duckdns.org

# ========================================
# Resource Configuration (Reduced for home servers)
# ========================================
resources:
  limits:
    cpu: 500m     # 0.5 core max
    memory: 256Mi # 256MB max (low footprint)
  requests:
    cpu: 100m     # 0.1 core baseline
    memory: 128Mi # 128MB baseline

# ========================================
# Health Probes (Conservative timing)
# ========================================
livenessProbe:
  enabled: true
  httpGet:
    path: /alive
    port: http
  initialDelaySeconds: 60
  periodSeconds: 30
  timeoutSeconds: 10
  failureThreshold: 6

readinessProbe:
  enabled: true
  httpGet:
    path: /alive
    port: http
  initialDelaySeconds: 30
  periodSeconds: 20
  timeoutSeconds: 10
  failureThreshold: 3

startupProbe:
  enabled: true
  httpGet:
    path: /alive
    port: http
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 10
  failureThreshold: 30

# ========================================
# Autoscaling (Disabled for home servers)
# ========================================
autoscaling:
  enabled: false

# ========================================
# Pod Disruption Budget (Disabled)
# ========================================
podDisruptionBudget:
  enabled: false

# ========================================
# Network Policy (Disabled for simplicity)
# ========================================
networkPolicy:
  enabled: false

# ========================================
# Scheduling
# ========================================
nodeSelector: {}

tolerations: []

affinity: {}

# ========================================
# Pod Security
# ========================================
podSecurityContext:
  fsGroup: 1000
  runAsUser: 1000
  runAsGroup: 1000
  runAsNonRoot: true

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: false

# ========================================
# Monitoring (Disabled)
# ========================================
monitoring:
  enabled: false
