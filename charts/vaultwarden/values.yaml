# Vaultwarden Helm Chart - Default Values
#
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# ========================================
# 1. Vaultwarden Configuration
# ========================================
vaultwarden:
  # Domain URL for web-vault (REQUIRED for proper functionality)
  # Web Crypto API requires HTTPS or http://localhost
  domain: ""  # e.g., "https://vault.example.com"

  # Admin panel configuration
  admin:
    enabled: true
    # Admin token (leave empty to generate random token)
    # If set, must be argon2 PHC string (use `vaultwarden hash` to generate)
    token: ""
    # Disable admin token (open access - NOT RECOMMENDED)
    disableAdminToken: false

  # SMTP configuration for email notifications
  smtp:
    enabled: false
    host: ""
    port: 587
    security: "starttls"  # starttls, force_tls, off
    username: ""
    password: ""
    from: ""
    fromName: "Vaultwarden"

  # Sign-up configuration
  signups:
    allowed: true
    # Require email verification for new accounts
    verifySignup: false
    # Allowed email domains (comma-separated, empty = all)
    allowedDomains: ""
    # Allow invitations even if signups are disabled
    allowInvitations: true

  # Security settings
  security:
    # Require two-factor authentication for all users
    require2FA: false
    # Show password hints
    showPasswordHint: true
    # Enable WebSocket notifications
    websocketEnabled: true
    # Icon download configuration
    iconService: "internal"  # internal, bitwarden, duckduckgo, google
    disableIconDownload: false

  # Attachment configuration
  attachments:
    # Maximum file size for attachments (in MB)
    maxSize: 10

  # Send configuration (Bitwarden Send feature)
  sends:
    # Enable Bitwarden Send
    enabled: true
    # Allow users to hide their email on Sends
    hideEmail: true

  # Performance tuning
  workers: 0  # 0 = auto-detect CPU cores

  # Advanced: Additional environment variables
  # These will override auto-generated vars
  extraEnv: []
  # - name: LOG_LEVEL
  #   value: "debug"

# ========================================
# 2. External Dependencies
# ========================================
# Vaultwarden supports SQLite (embedded) or external PostgreSQL/MySQL

# SQLite mode (default) - uses PVC for data directory
sqlite:
  enabled: true

# PostgreSQL backend
postgresql:
  enabled: false  # Set to true to use external PostgreSQL instead of SQLite
  external:
    enabled: false
    host: ""
    port: 5432
    database: "vaultwarden"
    username: "vaultwarden"
    password: ""  # Required if postgresql.enabled=true

# MySQL/MariaDB backend (alternative to PostgreSQL)
mysql:
  enabled: false  # Set to true to use external MySQL instead of SQLite
  external:
    enabled: false
    host: ""
    port: 3306
    database: "vaultwarden"
    username: "vaultwarden"
    password: ""  # Required if mysql.enabled=true

# ========================================
# 3. Persistence
# ========================================
persistence:
  enabled: true

  # Data directory (SQLite database + attachments)
  data:
    enabled: true
    storageClass: ""
    accessMode: ReadWriteOnce
    size: 1Gi
    mountPath: /data
    # Use existing claim
    existingClaim: ""
    # Reclaim policy
    reclaimPolicy: Retain

# ========================================
# 4. Deployment Mode
# ========================================
# When using SQLite: StatefulSet (requires stable storage)
# When using external DB: Deployment (stateless)
#
# This is controlled automatically:
# - sqlite.enabled=true → StatefulSet
# - postgresql.enabled=true OR mysql.enabled=true → Deployment

workloadType: "auto"  # auto, statefulset, deployment

# ========================================
# 5. Basic Kubernetes Configuration
# ========================================
replicaCount: 1

image:
  repository: vaultwarden/server
  pullPolicy: IfNotPresent
  # Overrides the image tag whose default is the chart appVersion
  tag: ""

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

# ========================================
# 6. RBAC Configuration
# ========================================
rbac:
  # Specifies whether RBAC resources should be created
  create: true
  # Annotations to add to the Role and RoleBinding
  annotations: {}

# ========================================
# 7. Service Account
# ========================================
serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # Automatically mount a ServiceAccount's API credentials?
  automount: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

# ========================================
# 8. Pod Configuration
# ========================================
podAnnotations: {}
podLabels: {}

podSecurityContext:
  fsGroup: 1000
  runAsUser: 1000
  runAsGroup: 1000
  runAsNonRoot: true

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: false  # Vaultwarden needs write access to /data

# ========================================
# 9. Service Configuration
# ========================================
service:
  type: ClusterIP
  ports:
    - name: http
      port: 80
      targetPort: 80
      protocol: TCP
    # WebSocket port (if websocketEnabled: true)
    - name: websocket
      port: 3012
      targetPort: 3012
      protocol: TCP

# ========================================
# 10. Ingress Configuration
# ========================================
ingress:
  enabled: false
  className: ""
  annotations: {}
    # nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    # cert-manager.io/cluster-issuer: "letsencrypt-prod"
  hosts:
    - host: vault.example.com
      paths:
        - path: /
          pathType: Prefix
  tls: []
  #  - secretName: vaultwarden-tls
  #    hosts:
  #      - vault.example.com

# ========================================
# 11. Resource Configuration
# ========================================
resources:
  limits:
    cpu: 1000m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 128Mi

# ========================================
# 12. Health Probes
# ========================================
livenessProbe:
  enabled: true
  httpGet:
    path: /alive
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  enabled: true
  httpGet:
    path: /alive
    port: http
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

startupProbe:
  enabled: true
  httpGet:
    path: /alive
    port: http
  initialDelaySeconds: 5
  periodSeconds: 5
  timeoutSeconds: 5
  failureThreshold: 30

# ========================================
# 13. Autoscaling (Deployment mode only)
# ========================================
autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 5
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 80

# ========================================
# 14. Pod Disruption Budget
# ========================================
podDisruptionBudget:
  enabled: false
  minAvailable: 1
  # maxUnavailable: 1

# ========================================
# 15. Network Policy
# ========================================
networkPolicy:
  enabled: false
  # Ingress rules
  ingress: []
  # - from:
  #   - namespaceSelector:
  #       matchLabels:
  #         name: ingress-nginx
  #   ports:
  #   - protocol: TCP
  #     port: 80
  # Egress rules
  egress: []
  # - to:
  #   - namespaceSelector: {}
  #   ports:
  #   - protocol: TCP
  #     port: 5432  # PostgreSQL

# ========================================
# 16. Scheduling
# ========================================
nodeSelector: {}

tolerations: []

affinity: {}

# ============================================================================
# 17. Backup & Recovery Configuration
# ============================================================================
# NOTE: This is DOCUMENTATION ONLY - backups are performed via Makefile targets
# The chart does NOT create automated backup CronJobs
# See docs/vaultwarden-backup-guide.md for detailed procedures

backup:
  # Documentation flag - does not enable automated backups
  enabled: false

  # Backup strategy overview
  documentation:
    # Backup components (4 layers)
    strategy: "Data Directory + Database + Configuration + PVC Snapshots"

    # Backup tools/methods
    tools:
      - "rsync/tar for data directory"
      - "sqlite3 .backup for SQLite"
      - "pg_dump for PostgreSQL"
      - "mysqldump for MySQL"
      - "kubectl cp for configuration"
      - "VolumeSnapshot API for PVC snapshots"

    # Components to backup
    components:
      dataDirectory:
        description: "Vault database (SQLite), attachments, icons, RSA keys, Sends"
        location: "Data PVC (/data)"
        size: "Small to medium (MB-GB)"
        method: "tar (full), rsync (incremental)"
        priority: "Critical"

      database:
        description: "Vault metadata, items (PostgreSQL/MySQL mode)"
        location: "External database"
        size: "Small to medium (MB-GB)"
        method: "pg_dump, mysqldump"
        priority: "Critical (external DB mode)"

      configuration:
        description: "Kubernetes resources, Helm values, environment variables"
        location: "ConfigMaps, Secrets, Helm release"
        size: "Very small (KB)"
        method: "kubectl export, helm get"
        priority: "High"

      pvcSnapshots:
        description: "Point-in-time storage snapshots"
        location: "Storage backend"
        size: "Same as data directory"
        method: "VolumeSnapshot API"
        priority: "Medium (disaster recovery)"

    # Recovery Time/Point Objectives
    targets:
      rto: "< 1 hour (complete instance recovery)"
      rpo: "24 hours (daily backups), 1 hour (hourly critical)"
      dataRecovery: "< 30 minutes"
      databaseRecovery: "< 15 minutes"
      configRecovery: "< 10 minutes"

    # Backup frequency recommendations
    frequency:
      dataDirectory: "Hourly or Daily (depending on criticality)"
      database: "Daily (hourly for critical deployments)"
      configuration: "On every change"
      pvcSnapshots: "Weekly"

    # Makefile commands for backup
    commands:
      fullBackup: "make -f make/ops/vaultwarden.mk vw-full-backup"
      backupData: "make -f make/ops/vaultwarden.mk vw-backup-data-full"
      backupDataIncremental: "make -f make/ops/vaultwarden.mk vw-backup-data-incremental"
      backupSQLite: "make -f make/ops/vaultwarden.mk vw-backup-sqlite"
      backupPostgreSQL: "make -f make/ops/vaultwarden.mk vw-backup-postgres"
      backupMySQL: "make -f make/ops/vaultwarden.mk vw-backup-mysql"
      backupConfig: "make -f make/ops/vaultwarden.mk vw-backup-config"
      snapshotData: "make -f make/ops/vaultwarden.mk vw-snapshot-data"

    # Makefile commands for recovery
    recovery:
      restoreData: "make -f make/ops/vaultwarden.mk vw-restore-data BACKUP_FILE=..."
      restorePostgreSQL: "make -f make/ops/vaultwarden.mk vw-restore-postgres BACKUP_FILE=..."
      restoreMySQL: "make -f make/ops/vaultwarden.mk vw-restore-mysql BACKUP_FILE=..."
      restoreConfig: "make -f make/ops/vaultwarden.mk vw-restore-config BACKUP_FILE=..."
      fullRecovery: "make -f make/ops/vaultwarden.mk vw-full-recovery DATA_BACKUP=... DB_BACKUP=..."

    # Best practices
    bestPractices:
      - "Test restore procedures quarterly"
      - "Store backups in different availability zone"
      - "Encrypt sensitive backups (config contains admin token, SMTP passwords)"
      - "Always backup before upgrades"
      - "Verify backup integrity regularly"
      - "Document backup locations and encryption keys"
      - "Use SQLite .backup command, never direct file copy while running"
      - "Monitor backup success and alert on failures"

    # Complete guide reference
    guide: "docs/vaultwarden-backup-guide.md"

# ============================================================================
# 18. Upgrade Configuration
# ============================================================================
# NOTE: This is DOCUMENTATION ONLY - upgrades are performed via Helm and validation
# The chart does NOT perform automated upgrades
# See docs/vaultwarden-upgrade-guide.md for detailed procedures

upgrade:
  # Documentation flag - does not enable automated upgrades
  enabled: false

  # Always backup before upgrade
  preUpgradeBackup: true

  # Upgrade strategy overview
  documentation:
    # Upgrade philosophy
    philosophy:
      - "Minimize downtime (use rolling upgrades when possible)"
      - "Always backup first (CRITICAL - vault data is irreplaceable)"
      - "Test in staging environment"
      - "Database schema automatically migrated on startup"
      - "Rollback requires database restore (schema downgrades not supported)"

    # Upgrade strategies
    strategies:
      rollingUpgrade:
        description: "Zero-downtime upgrade for patch/minor versions"
        bestFor: "1.34.0 → 1.34.3 (patch) or 1.34.x → 1.35.x (minor)"
        downtime: "None"
        complexity: "Low"
        method: "Helm upgrade with new image tag"

      inPlaceUpgrade:
        description: "Upgrade with brief downtime for major versions"
        bestFor: "1.30.x → 1.34.x (major version)"
        downtime: "10-15 minutes"
        complexity: "Medium"
        method: "Scale down → Helm upgrade → Scale up"

      blueGreenDeployment:
        description: "Zero-downtime major version upgrade"
        bestFor: "Production with zero-downtime requirement"
        downtime: "None (instant cutover)"
        complexity: "High"
        method: "Deploy to separate namespace → Test → Switch ingress"

      databaseMigration:
        description: "Migrate database backend (SQLite → PostgreSQL)"
        bestFor: "Moving to high-availability setup"
        downtime: "1-2 hours"
        complexity: "Very High"
        method: "Export SQLite → Convert → Import PostgreSQL"

    # Version-specific upgrade notes
    versionNotes:
      "1.32.x → 1.34.x":
        - "Alpine Linux 3.20 update (may require permission fixes)"
        - "Database migration adds indices (< 1 minute)"
        - "WebAuthn improvements"
        - "Organization enhancements"
        - "No breaking changes"
      "1.30.x → 1.32.x":
        - "Emergency access feature added"
        - "Event logging improvements"
        - "SQLite performance optimizations"
        - "No breaking changes"

    # Pre-upgrade checklist
    preUpgradeChecklist:
      - "Review Vaultwarden release notes"
      - "Create full backup (vw-full-backup)"
      - "Create PVC snapshot (vw-snapshot-data)"
      - "Check database health (vw-db-integrity)"
      - "Export current Helm values"
      - "Test backup restore (recommended)"
      - "Plan maintenance window (if downtime required)"
      - "Notify users of upgrade schedule"

    # Post-upgrade validation
    postUpgradeValidation:
      - "Verify pod health (kubectl get pods)"
      - "Check Vaultwarden version (vw-version)"
      - "Test database integrity (vw-db-integrity)"
      - "Login to web vault"
      - "Verify password items load correctly"
      - "Test password creation/update"
      - "Verify file attachments work"
      - "Test Send feature"
      - "Test organization features (if used)"
      - "Sync from mobile app"
      - "Monitor logs for errors (vw-logs)"

    # Makefile commands
    commands:
      preUpgradeCheck: "make -f make/ops/vaultwarden.mk vw-pre-upgrade-check"
      fullBackup: "make -f make/ops/vaultwarden.mk vw-full-backup"
      postUpgradeCheck: "make -f make/ops/vaultwarden.mk vw-post-upgrade-check"
      snapshotData: "make -f make/ops/vaultwarden.mk vw-snapshot-data"

    # Rollback procedures
    rollback:
      helmOnly:
        description: "For upgrades without database migration"
        method: "helm rollback vaultwarden"
        downtime: "2-5 minutes"

      fullDatabaseRestore:
        description: "For upgrades with database migration"
        method: "Restore database → Rollback Helm → Restart"
        downtime: "15-30 minutes"

      pvcSnapshot:
        description: "Fastest rollback using storage snapshot"
        method: "Restore from PVC snapshot → Rollback Helm"
        downtime: "5-10 minutes"

    # Complete guide reference
    guide: "docs/vaultwarden-upgrade-guide.md"

# ============================================================================
# 19. Monitoring (Optional)
# ============================================================================
# NOTE: Vaultwarden does not natively expose Prometheus metrics
# Consider using a third-party exporter if monitoring is required
monitoring:
  enabled: false
  serviceMonitor:
    enabled: false
    interval: 30s
    scrapeTimeout: 10s
