# Vaultwarden Helm Chart - Production Example Configuration
#
# Optimized for:
# - Production environments
# - External PostgreSQL database
# - High availability with autoscaling
# - Full security hardening
# - HTTPS with cert-manager
#
# Features:
# - External PostgreSQL with connection pooling
# - SMTP for email notifications
# - Restricted sign-ups with domain whitelist
# - Mandatory 2FA enforcement
# - Ingress with TLS
# - HPA for auto-scaling (2-5 replicas)
# - PodDisruptionBudget for HA
# - NetworkPolicy for security

# ========================================
# Vaultwarden Configuration
# ========================================
vaultwarden:
  # REQUIRED: Domain URL (must be HTTPS for production)
  domain: "https://vault.example.com"

  # Admin panel configuration
  admin:
    enabled: true
    # Leave empty to generate random token on first install
    token: ""
    disableAdminToken: false

  # SMTP configuration for email notifications
  smtp:
    enabled: true
    host: "smtp.sendgrid.net"
    port: 587
    security: "starttls"
    username: "apikey"
    password: ""  # Set via --set or external secret
    from: "noreply@example.com"
    fromName: "Vaultwarden"

  # Sign-up configuration (restricted)
  signups:
    allowed: false  # Disable public registration
    verifySignup: true
    allowedDomains: "example.com,example.org"  # Only allow company domains
    allowInvitations: true  # Allow existing users to invite

  # Security settings
  security:
    require2FA: true  # Mandatory 2FA for all users
    showPasswordHint: false  # Disable password hints for security
    websocketEnabled: true
    iconService: "internal"
    disableIconDownload: false

  # Attachment configuration
  attachments:
    maxSize: 50  # 50MB max attachment size

  # Send configuration
  sends:
    enabled: true
    hideEmail: true

  # Performance tuning (0 = auto-detect CPU cores)
  workers: 0

# ========================================
# External Dependencies
# ========================================
# Use external PostgreSQL (NOT SQLite for production)
sqlite:
  enabled: false

postgresql:
  enabled: true
  external:
    enabled: true
    host: "postgres-ha.database.svc.cluster.local"
    port: 5432
    database: "vaultwarden"
    username: "vaultwarden"
    password: ""  # REQUIRED - set via --set or values override

mysql:
  enabled: false

# ========================================
# Persistence
# ========================================
persistence:
  enabled: true

  # Data directory (attachments only when using external DB)
  data:
    enabled: true
    storageClass: "fast-ssd"
    accessMode: ReadWriteOnce
    size: 10Gi
    mountPath: /data
    reclaimPolicy: Retain

# ========================================
# Deployment Mode (auto = Deployment for PostgreSQL)
# ========================================
workloadType: "auto"

# ========================================
# Basic Kubernetes Configuration
# ========================================
replicaCount: 2  # Initial replicas (HPA will scale 2-5)

image:
  repository: vaultwarden/server
  pullPolicy: IfNotPresent
  tag: ""  # Uses chart appVersion

# ========================================
# Service Configuration
# ========================================
service:
  type: ClusterIP
  ports:
    - name: http
      port: 80
      targetPort: 80
      protocol: TCP
    - name: websocket
      port: 3012
      targetPort: 3012
      protocol: TCP

# ========================================
# Ingress Configuration
# ========================================
ingress:
  enabled: true
  className: "nginx"
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    # WebSocket support
    nginx.ingress.kubernetes.io/configuration-snippet: |
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
  hosts:
    - host: vault.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: vaultwarden-tls
      hosts:
        - vault.example.com

# ========================================
# Resource Configuration
# ========================================
resources:
  limits:
    cpu: 2000m
    memory: 1Gi
  requests:
    cpu: 500m
    memory: 512Mi

# ========================================
# Health Probes
# ========================================
livenessProbe:
  enabled: true
  httpGet:
    path: /alive
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  enabled: true
  httpGet:
    path: /alive
    port: http
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

startupProbe:
  enabled: true
  httpGet:
    path: /alive
    port: http
  initialDelaySeconds: 5
  periodSeconds: 5
  timeoutSeconds: 5
  failureThreshold: 30

# ========================================
# Autoscaling
# ========================================
autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 5
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# ========================================
# Pod Disruption Budget
# ========================================
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# ========================================
# Network Policy
# ========================================
networkPolicy:
  enabled: true
  # Allow ingress from ingress-nginx namespace
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
      ports:
        - protocol: TCP
          port: 80
        - protocol: TCP
          port: 3012
  # Allow egress to PostgreSQL and internet (SMTP, icon downloads)
  egress:
    # PostgreSQL database
    - to:
        - namespaceSelector:
            matchLabels:
              name: database
      ports:
        - protocol: TCP
          port: 5432
    # DNS
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: UDP
          port: 53
    # SMTP (port 587)
    - ports:
        - protocol: TCP
          port: 587
    # HTTPS for icon downloads
    - ports:
        - protocol: TCP
          port: 443

# ========================================
# Scheduling
# ========================================
nodeSelector: {}

tolerations: []

# Pod anti-affinity for HA (spread across nodes)
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: vaultwarden
          topologyKey: kubernetes.io/hostname

# ========================================
# Pod Security
# ========================================
podSecurityContext:
  fsGroup: 1000
  runAsUser: 1000
  runAsGroup: 1000
  runAsNonRoot: true

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: false

# ========================================
# Monitoring (Optional)
# ========================================
monitoring:
  enabled: false
  serviceMonitor:
    enabled: false
    interval: 30s
    scrapeTimeout: 10s
