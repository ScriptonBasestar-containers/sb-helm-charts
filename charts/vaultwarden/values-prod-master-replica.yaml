# Vaultwarden values for Production - Master-Replica
# Bitwarden-compatible password manager for production use
# Note: Use external PostgreSQL/MySQL for HA deployment
# Use: helm install vaultwarden ./charts/vaultwarden -f charts/vaultwarden/values-prod-master-replica.yaml

vaultwarden:
  domain: ""  # REQUIRED - production domain (https://vault.example.com)

  admin:
    enabled: true
    token: ""  # REQUIRED - generate with `vaultwarden hash`
    disableAdminToken: false

  smtp:
    enabled: false  # Enable and configure for email in production
    host: ""  # Set SMTP host when enabling
    port: 587
    security: "starttls"
    username: ""  # Set username when enabling
    password: ""  # Set password when enabling
    from: ""  # Set from address when enabling
    fromName: "Vaultwarden"

  signups:
    allowed: false  # Disable public signups in production
    verifySignup: true  # Require email verification
    allowedDomains: ""  # Set to your domain (e.g., "example.com")
    allowInvitations: true

  security:
    require2FA: true  # Enforce 2FA for all users
    showPasswordHint: false  # Disable for security
    websocketEnabled: true
    iconService: "internal"
    disableIconDownload: false

  attachments:
    maxSize: 10  # 10MB

  sends:
    enabled: true
    hideEmail: true

  workers: 0

# Use external database for production HA
sqlite:
  enabled: false  # Disable SQLite for HA

postgresql:
  enabled: true  # Use PostgreSQL for HA
  external:
    enabled: true
    host: ""  # REQUIRED - production PostgreSQL host
    port: 5432
    database: "vaultwarden"
    username: "vaultwarden"
    password: ""  # REQUIRED

mysql:
  enabled: false
  # Alternative: MySQL/MariaDB
  # external:
  #   enabled: true
  #   host: ""
  #   port: 3306
  #   database: "vaultwarden"
  #   username: "vaultwarden"
  #   password: ""

# Persistence (for attachments only when using external DB)
persistence:
  enabled: true
  data:
    enabled: true
    storageClass: ""
    accessMode: ReadWriteMany  # Required for multi-replica
    size: 20Gi  # Production capacity
    mountPath: /data
    reclaimPolicy: Retain

workloadType: "auto"  # Uses Deployment with external DB
replicaCount: 2  # HA deployment

image:
  repository: vaultwarden/server
  pullPolicy: IfNotPresent
  tag: ""

serviceAccount:
  create: true
  automount: true

podAnnotations:
  prometheus.io/scrape: "false"  # No native metrics

podLabels:
  environment: "production"
  tier: "security"

podSecurityContext:
  fsGroup: 1000
  runAsUser: 1000
  runAsGroup: 1000
  runAsNonRoot: true

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: false

service:
  type: ClusterIP
  ports:
    - name: http
      port: 80
      targetPort: 80
      protocol: TCP
    - name: websocket
      port: 3012
      targetPort: 3012
      protocol: TCP

ingress:
  enabled: true
  className: "nginx"
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
  hosts:
    - host: vault.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: vaultwarden-tls
      hosts:
        - vault.example.com

resources:
  limits:
    cpu: 1000m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 128Mi

livenessProbe:
  enabled: true
  httpGet:
    path: /alive
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  enabled: true
  httpGet:
    path: /alive
    port: http
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

startupProbe:
  enabled: true
  httpGet:
    path: /alive
    port: http
  initialDelaySeconds: 5
  periodSeconds: 5
  timeoutSeconds: 5
  failureThreshold: 30

autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 5
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 80

podDisruptionBudget:
  enabled: true
  minAvailable: 1

networkPolicy:
  enabled: true
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
      ports:
        - protocol: TCP
          port: 80
        - protocol: TCP
          port: 3012
  egress:
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 5432  # PostgreSQL
        - protocol: TCP
          port: 587   # SMTP
        - protocol: UDP
          port: 53    # DNS

backup:
  enabled: true
  schedule: "0 2 * * *"  # Daily at 2 AM
  retention: 30  # 30 days
  storageClass: ""
  size: 10Gi

monitoring:
  enabled: false
  serviceMonitor:
    enabled: false

# Pod anti-affinity for HA
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: vaultwarden
          topologyKey: kubernetes.io/hostname

nodeSelector: {}
tolerations: []
