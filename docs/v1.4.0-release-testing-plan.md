# v1.4.0 Release Testing Plan

## Overview

Comprehensive testing plan for validating v1.4.0 release readiness before production deployment.

**Release Target**: v1.4.0
**Test Scope**: 28 enhanced charts (20 newly enhanced in v1.4.0 + 8 from v1.3.0)
**Test Categories**: 5 categories (Documentation, RBAC, Backup/Recovery, Upgrade, Integration)

---

## Test Objectives

### Primary Objectives
1. **Documentation Completeness** - Verify all 28 enhanced charts have complete documentation
2. **RBAC Validation** - Validate RBAC templates and configurations
3. **Backup/Recovery** - Verify backup and recovery procedures
4. **Upgrade Procedures** - Validate upgrade strategies and rollback
5. **Integration** - Verify cross-chart integrations and dependencies

### Success Criteria
- ✅ All 28 enhanced charts pass documentation checks
- ✅ All RBAC templates render correctly
- ✅ All backup guides have validated procedures
- ✅ All upgrade guides have validated strategies
- ✅ All Makefile targets execute without errors
- ✅ No broken links in documentation
- ✅ All comprehensive guides are complete

---

## Testing Categories

### 1. Documentation Completeness Testing

**Objective**: Verify all enhanced charts have complete documentation sets

**Test Scope**: 28 enhanced charts

#### 1.1 Chart-Specific Documentation

For each of the 28 enhanced charts, verify:

**Required Files:**
- [ ] `docs/{chart}-backup-guide.md` exists (~900-1,500 lines)
- [ ] `docs/{chart}-upgrade-guide.md` exists (~900-1,500 lines)
- [ ] `charts/{chart}/README.md` has enhanced sections
- [ ] `charts/{chart}/values.yaml` has backup/upgrade documentation
- [ ] `make/ops/{chart}.mk` has operational targets

**README Sections (4 required):**
- [ ] Backup & Recovery section (80-110 lines, links to backup guide)
- [ ] Security & RBAC section (includes RBAC configuration examples)
- [ ] Operations section (links to Makefile commands)
- [ ] Upgrading section (120-200 lines, links to upgrade guide)

**values.yaml Documentation:**
- [ ] `rbac` section with create/annotations options
- [ ] `backup` section with strategy documentation
- [ ] `upgrade` section with strategies documentation
- [ ] Documentation-only flags clearly marked

**Makefile Targets (minimum 15+):**
- [ ] Backup operations targets
- [ ] Pre/post-upgrade check targets
- [ ] Health check targets
- [ ] Basic operational targets (logs, shell, port-forward)

#### 1.2 Backup Guide Validation

For each backup guide (`docs/{chart}-backup-guide.md`):

**Structure:**
- [ ] Overview section (backup strategy summary)
- [ ] Component-specific backup procedures (3-5 components)
- [ ] Recovery procedures
- [ ] RTO/RPO targets documented
- [ ] Best practices section
- [ ] Troubleshooting section

**Content Quality:**
- [ ] All backup commands are syntactically valid
- [ ] All file paths are correct
- [ ] All environment variables are defined
- [ ] All prerequisites are listed
- [ ] All examples are complete and tested

#### 1.3 Upgrade Guide Validation

For each upgrade guide (`docs/{chart}-upgrade-guide.md`):

**Structure:**
- [ ] Overview section
- [ ] Pre-upgrade checklist
- [ ] Multiple upgrade strategies (3-4 strategies)
- [ ] Version-specific notes
- [ ] Post-upgrade validation
- [ ] Rollback procedures
- [ ] Troubleshooting section

**Content Quality:**
- [ ] All upgrade commands are syntactically valid
- [ ] All backup commands are referenced
- [ ] All validation steps are clear
- [ ] All version compatibility notes are accurate

#### 1.4 Comprehensive Guides Validation

Verify all 7 comprehensive guides:

**1. Disaster Recovery Guide** (`docs/disaster-recovery-guide.md` - 1,299 lines)
- [ ] Covers all 28 enhanced charts
- [ ] 4-tier architecture documented
- [ ] Master backup script present (backup-orchestrator.sh)
- [ ] 7-phase full cluster recovery documented
- [ ] RTO/RPO matrix complete for all 28 charts

**2. Performance Optimization Guide** (`docs/performance-optimization-guide.md` - 2,335 lines)
- [ ] Resource sizing matrices (Tier 1-3)
- [ ] Scaling strategies (HPA, KEDA, read replicas)
- [ ] Database optimization sections
- [ ] Storage tuning sections
- [ ] Benchmarking methodology

**3. Cost Optimization Guide** (`docs/cost-optimization-guide.md` - 1,330 lines)
- [ ] Resource tracking (Prometheus metrics)
- [ ] Cost allocation matrix
- [ ] Spot instance strategies
- [ ] Storage tier optimization
- [ ] FinOps best practices

**4. Service Mesh Integration Guide** (`docs/service-mesh-integration-guide.md` - 1,497 lines)
- [ ] Istio integration examples
- [ ] Linkerd integration examples
- [ ] Traffic management patterns
- [ ] Multi-cluster setup

**5. Automated Testing Framework Guide** (`docs/automated-testing-framework-guide.md` - 1,340 lines)
- [ ] Test architecture (4-tier organization)
- [ ] Integration tests (BATS framework)
- [ ] Upgrade tests
- [ ] Performance tests
- [ ] CI/CD automation (GitHub Actions)

**6. Backup Orchestration Guide** (`docs/backup-orchestration-guide.md` - 1,440 lines)
- [ ] Master backup script (backup-orchestrator.sh)
- [ ] Backup verification system
- [ ] Retention management
- [ ] S3/MinIO storage integration
- [ ] Monitoring & alerting

**7. Performance Benchmarking Baseline** (`docs/performance-benchmarking-baseline.md` - 1,175 lines)
- [ ] Baseline metrics for all 28 charts
- [ ] Benchmarking methodology
- [ ] Benchmark execution scripts
- [ ] Performance tracking dashboards
- [ ] Regression detection alerts

---

### 2. RBAC Template Testing

**Objective**: Verify all RBAC templates render correctly and have proper permissions

#### 2.1 Template Rendering

For each of the 28 enhanced charts:

**Template Files:**
- [ ] `charts/{chart}/templates/rbac.yaml` exists
- [ ] Template contains Role or ClusterRole
- [ ] Template contains RoleBinding or ClusterRoleBinding
- [ ] Template has conditional rendering based on `rbac.create`

**Helm Template Validation:**
```bash
# For each chart
helm template {chart} charts/{chart} \
  --set rbac.create=true \
  --debug > /tmp/{chart}-rbac-test.yaml

# Verify output
kubectl apply --dry-run=client -f /tmp/{chart}-rbac-test.yaml
```

#### 2.2 RBAC Permissions Validation

For each chart, verify permissions are appropriate:

**Namespace-scoped (most charts):**
- [ ] Role grants read access to: ConfigMaps, Secrets, Pods, Services, Endpoints, PVCs
- [ ] No write permissions unless explicitly needed
- [ ] RoleBinding binds ServiceAccount to Role

**Cluster-scoped (exporters, Promtail):**
- [ ] ClusterRole grants read access to required cluster resources
- [ ] ClusterRoleBinding binds ServiceAccount to ClusterRole
- [ ] Minimal permissions (least privilege)

#### 2.3 values.yaml RBAC Configuration

For each chart:

**RBAC Section:**
```yaml
rbac:
  create: true  # Default
  annotations: {}  # Optional annotations
```

- [ ] `rbac.create` defaults to true
- [ ] Annotations are optional and empty by default
- [ ] Documentation explains RBAC configuration

---

### 3. Backup & Recovery Testing

**Objective**: Verify backup procedures are valid and recovery is possible

#### 3.1 Makefile Target Testing

For each of the 28 enhanced charts:

**Backup Targets:**
- [ ] `{chart}-backup-all` target exists and executes
- [ ] `{chart}-full-backup` target exists (if applicable)
- [ ] Backup creates files in expected locations
- [ ] Backup files have correct permissions
- [ ] Backup logs are captured

**Example Test:**
```bash
# Test PostgreSQL backup
make -f make/ops/postgresql.mk pg-backup-all \
  NAMESPACE=test \
  BACKUP_DIR=/tmp/pg-test-backup

# Verify backup files created
ls -lh /tmp/pg-test-backup/
```

#### 3.2 Backup Orchestration Testing

**Master Backup Script:**
- [ ] `scripts/backup-orchestrator.sh` exists
- [ ] Script has all 28 charts in TIER arrays
- [ ] Script supports PARALLEL mode
- [ ] Script supports VERIFY mode
- [ ] Script supports UPLOAD mode (S3/MinIO)
- [ ] Script generates backup logs
- [ ] Script generates status files

**Test Execution:**
```bash
# Dry-run test
NAMESPACE=test \
BACKUP_ROOT=/tmp/backup-test \
DRY_RUN=true \
./scripts/backup-orchestrator.sh

# Verify execution plan
cat /tmp/backup-test/backup-plan-*.txt
```

#### 3.3 Recovery Validation

For critical charts (PostgreSQL, MySQL, Redis):

**Recovery Test:**
1. Create test data
2. Perform backup
3. Delete test data
4. Perform recovery
5. Verify data restored

**Example Test (PostgreSQL):**
```bash
# 1. Create test data
kubectl exec -n test postgresql-0 -- \
  psql -U postgres -c "CREATE DATABASE testdb;"
kubectl exec -n test postgresql-0 -- \
  psql -U postgres -d testdb -c "CREATE TABLE test (id INT, name TEXT);"
kubectl exec -n test postgresql-0 -- \
  psql -U postgres -d testdb -c "INSERT INTO test VALUES (1, 'test');"

# 2. Backup
make -f make/ops/postgresql.mk pg-backup-all \
  NAMESPACE=test \
  BACKUP_DIR=/tmp/pg-backup

# 3. Delete data
kubectl exec -n test postgresql-0 -- \
  psql -U postgres -c "DROP DATABASE testdb;"

# 4. Restore
make -f make/ops/postgresql.mk pg-restore-all \
  NAMESPACE=test \
  BACKUP_DIR=/tmp/pg-backup

# 5. Verify
kubectl exec -n test postgresql-0 -- \
  psql -U postgres -d testdb -c "SELECT * FROM test;"
# Expected: (1, 'test')
```

---

### 4. Upgrade Procedure Testing

**Objective**: Verify upgrade strategies are valid and rollback works

#### 4.1 Pre-Upgrade Checks

For each of the 28 enhanced charts:

**Pre-Upgrade Target:**
- [ ] `{chart}-pre-upgrade-check` target exists
- [ ] Target validates current deployment
- [ ] Target checks version compatibility
- [ ] Target verifies backup status
- [ ] Target reports readiness

**Example Test:**
```bash
# Test Keycloak pre-upgrade check
make -f make/ops/keycloak.mk kc-pre-upgrade-check \
  NAMESPACE=test \
  TARGET_VERSION=26.0.0

# Expected output: Pre-upgrade checks passed
```

#### 4.2 Post-Upgrade Validation

For each chart:

**Post-Upgrade Target:**
- [ ] `{chart}-post-upgrade-check` target exists
- [ ] Target validates deployment health
- [ ] Target verifies data integrity
- [ ] Target checks version
- [ ] Target reports success/failure

**Example Test:**
```bash
# Test Keycloak post-upgrade validation
make -f make/ops/keycloak.mk kc-post-upgrade-check \
  NAMESPACE=test

# Expected output: Post-upgrade validation passed
```

#### 4.3 Upgrade Strategy Validation

For each chart, verify all documented upgrade strategies are valid:

**Common Strategies:**
1. **Rolling Upgrade** - Zero downtime
2. **Blue-Green Deployment** - Parallel clusters
3. **Maintenance Window** - Full restart

**Test Approach:**
- [ ] Review upgrade guide for strategy documentation
- [ ] Verify Helm chart supports strategy (e.g., maxUnavailable, deployment strategy)
- [ ] Validate commands in upgrade guide are correct
- [ ] Check version-specific notes are accurate

#### 4.4 Rollback Testing

For critical charts:

**Rollback Validation:**
- [ ] `{chart}-upgrade-rollback` target exists
- [ ] Target restores previous version
- [ ] Target restores data from backup
- [ ] Target validates rollback success

**Example Test:**
```bash
# Simulate upgrade failure and rollback
make -f make/ops/postgresql.mk pg-upgrade-rollback \
  NAMESPACE=test \
  BACKUP_DIR=/tmp/pg-backup-pre-upgrade

# Verify version reverted
kubectl get pods -n test -l app.kubernetes.io/name=postgresql
```

---

### 5. Integration Testing

**Objective**: Verify cross-chart integrations work correctly

#### 5.1 Database Integration

**PostgreSQL Clients:**
- [ ] Keycloak → PostgreSQL integration
- [ ] Nextcloud → PostgreSQL integration
- [ ] Airflow → PostgreSQL integration
- [ ] MLflow → PostgreSQL integration
- [ ] Harbor → PostgreSQL integration

**MySQL Clients:**
- [ ] WordPress → MySQL integration

**Test Approach:**
```bash
# Deploy PostgreSQL
helm install postgresql charts/postgresql -n test

# Deploy Keycloak with PostgreSQL
helm install keycloak charts/keycloak \
  --set postgresql.external.enabled=true \
  --set postgresql.external.host=postgresql \
  -n test

# Verify connection
make -f make/ops/keycloak.mk kc-check-db NAMESPACE=test
```

#### 5.2 Redis Integration

**Redis Clients:**
- [ ] Keycloak → Redis (optional cache)
- [ ] Nextcloud → Redis (session/cache)
- [ ] Paperless-ngx → Redis (optional cache)
- [ ] Immich → Redis (cache)

**Test Approach:**
```bash
# Deploy Redis
helm install redis charts/redis -n test

# Deploy Nextcloud with Redis
helm install nextcloud charts/nextcloud \
  --set redis.external.enabled=true \
  --set redis.external.host=redis-master \
  -n test

# Verify connection
make -f make/ops/nextcloud.mk nextcloud-check-redis NAMESPACE=test
```

#### 5.3 Object Storage Integration

**MinIO/S3 Clients:**
- [ ] Airflow → MinIO (remote logging)
- [ ] MLflow → MinIO (artifact storage)
- [ ] Loki → MinIO (chunk storage)
- [ ] Tempo → MinIO (trace storage)
- [ ] Mimir → MinIO (block storage)

**Test Approach:**
```bash
# Deploy MinIO
helm install minio charts/minio -n test

# Deploy MLflow with MinIO
helm install mlflow charts/mlflow \
  --set storage.s3.enabled=true \
  --set storage.s3.endpoint=http://minio:9000 \
  -n test

# Verify connection
make -f make/ops/mlflow.mk mlflow-check-storage NAMESPACE=test
```

#### 5.4 Monitoring Integration

**Prometheus Exporters:**
- [ ] Node Exporter → Prometheus
- [ ] Kube State Metrics → Prometheus
- [ ] Blackbox Exporter → Prometheus
- [ ] Pushgateway → Prometheus

**Grafana Datasources:**
- [ ] Grafana → Prometheus
- [ ] Grafana → Loki
- [ ] Grafana → Tempo

**Test Approach:**
```bash
# Deploy Prometheus
helm install prometheus charts/prometheus -n monitoring

# Deploy Node Exporter with ServiceMonitor
helm install node-exporter charts/node-exporter \
  --set serviceMonitor.enabled=true \
  -n monitoring

# Verify ServiceMonitor created
kubectl get servicemonitor -n monitoring

# Query Prometheus for node metrics
make -f make/ops/prometheus.mk prom-query \
  NAMESPACE=monitoring \
  QUERY='up{job="node-exporter"}'
```

---

## Test Execution Plan

### Phase 1: Documentation Review (Day 1-2)
1. Run automated documentation validation script
2. Manual review of all 7 comprehensive guides
3. Verify all 28 chart READMEs have enhanced sections
4. Check all links in documentation (no 404s)

### Phase 2: RBAC Validation (Day 3)
1. Helm template rendering for all 28 charts
2. kubectl dry-run validation
3. Permission scope verification
4. values.yaml RBAC configuration check

### Phase 3: Backup Testing (Day 4-5)
1. Makefile target execution for all 28 charts
2. Backup orchestration script testing
3. Recovery validation for critical charts (PostgreSQL, MySQL, Redis)
4. Backup size and timing benchmarks

### Phase 4: Upgrade Testing (Day 6-7)
1. Pre-upgrade check validation
2. Post-upgrade validation
3. Upgrade strategy documentation review
4. Rollback testing for critical charts

### Phase 5: Integration Testing (Day 8-9)
1. Database integration tests
2. Redis integration tests
3. Object storage integration tests
4. Monitoring integration tests

### Phase 6: Final Validation (Day 10)
1. Review all test results
2. Document any issues found
3. Create issue tickets for post-release fixes
4. Sign-off on release readiness

---

## Test Automation Scripts

### Script 1: Documentation Validation

**File**: `scripts/validate-v1.4.0-docs.sh`

```bash
#!/bin/bash
# Validate v1.4.0 documentation completeness

CHARTS=(
  # Phase 1: Critical Infrastructure (6)
  prometheus loki tempo postgresql mysql redis
  # Phase 2: Application Charts (8)
  grafana nextcloud vaultwarden wordpress paperless-ngx immich jellyfin uptime-kuma
  # Phase 3: Supporting Infrastructure (6)
  minio mongodb rabbitmq promtail alertmanager memcached
  # From v1.3.0 (8)
  keycloak airflow harbor mlflow kafka elasticsearch mimir opentelemetry-collector
)

PASS=0
FAIL=0

for chart in "${CHARTS[@]}"; do
  echo "Validating $chart..."

  # Check backup guide
  if [[ -f "docs/${chart}-backup-guide.md" ]]; then
    echo "  ✅ Backup guide exists"
    ((PASS++))
  else
    echo "  ❌ Backup guide missing"
    ((FAIL++))
  fi

  # Check upgrade guide
  if [[ -f "docs/${chart}-upgrade-guide.md" ]]; then
    echo "  ✅ Upgrade guide exists"
    ((PASS++))
  else
    echo "  ❌ Upgrade guide missing"
    ((FAIL++))
  fi

  # Check Makefile
  if [[ -f "make/ops/${chart}.mk" ]]; then
    echo "  ✅ Makefile exists"
    ((PASS++))
  else
    echo "  ❌ Makefile missing"
    ((FAIL++))
  fi

  # Check RBAC template
  if [[ -f "charts/${chart}/templates/rbac.yaml" ]]; then
    echo "  ✅ RBAC template exists"
    ((PASS++))
  else
    echo "  ❌ RBAC template missing"
    ((FAIL++))
  fi
done

echo ""
echo "Summary: $PASS passed, $FAIL failed"
exit $FAIL
```

### Script 2: RBAC Template Validation

**File**: `scripts/validate-rbac-templates.sh`

```bash
#!/bin/bash
# Validate RBAC templates render correctly

CHARTS=(prometheus loki tempo postgresql mysql redis grafana nextcloud vaultwarden wordpress paperless-ngx immich jellyfin uptime-kuma minio mongodb rabbitmq promtail alertmanager memcached keycloak airflow harbor mlflow kafka elasticsearch mimir opentelemetry-collector)

PASS=0
FAIL=0

for chart in "${CHARTS[@]}"; do
  echo "Validating RBAC for $chart..."

  # Render template
  helm template test charts/${chart} \
    --set rbac.create=true \
    --debug > /tmp/${chart}-rbac-test.yaml 2>&1

  if [[ $? -eq 0 ]]; then
    # Validate with kubectl
    kubectl apply --dry-run=client -f /tmp/${chart}-rbac-test.yaml 2>&1

    if [[ $? -eq 0 ]]; then
      echo "  ✅ RBAC template valid"
      ((PASS++))
    else
      echo "  ❌ RBAC template invalid (kubectl validation failed)"
      ((FAIL++))
    fi
  else
    echo "  ❌ Template rendering failed"
    ((FAIL++))
  fi
done

echo ""
echo "Summary: $PASS passed, $FAIL failed"
exit $FAIL
```

### Script 3: Makefile Target Validation

**File**: `scripts/validate-makefile-targets.sh`

```bash
#!/bin/bash
# Validate Makefile targets exist

CHARTS=(prometheus loki tempo postgresql mysql redis grafana nextcloud vaultwarden wordpress paperless-ngx immich jellyfin uptime-kuma minio mongodb rabbitmq promtail alertmanager memcached keycloak airflow harbor mlflow kafka elasticsearch mimir opentelemetry-collector)

REQUIRED_TARGETS=(
  "backup-all"
  "pre-upgrade-check"
  "post-upgrade-check"
  "logs"
  "shell"
)

PASS=0
FAIL=0

for chart in "${CHARTS[@]}"; do
  echo "Validating Makefile targets for $chart..."

  makefile="make/ops/${chart}.mk"

  if [[ ! -f "$makefile" ]]; then
    echo "  ❌ Makefile not found"
    ((FAIL++))
    continue
  fi

  for target in "${REQUIRED_TARGETS[@]}"; do
    # Check if target exists (grep for target definition)
    if grep -q "^${chart}-${target}:" "$makefile" || \
       grep -q "^$(echo $chart | sed 's/-//g')-${target}:" "$makefile"; then
      echo "  ✅ Target ${target} exists"
      ((PASS++))
    else
      echo "  ❌ Target ${target} missing"
      ((FAIL++))
    fi
  done
done

echo ""
echo "Summary: $PASS passed, $FAIL failed"
exit $FAIL
```

---

## Test Results Tracking

### Test Execution Checklist

**Phase 1: Documentation Review**
- [ ] Documentation validation script executed
- [ ] All 7 comprehensive guides reviewed
- [ ] All 28 chart READMEs validated
- [ ] Link validation completed (no 404s)
- [ ] Issues documented: _____________

**Phase 2: RBAC Validation**
- [ ] RBAC template validation script executed
- [ ] All templates render correctly
- [ ] kubectl dry-run validation passed
- [ ] Permission scopes verified
- [ ] Issues documented: _____________

**Phase 3: Backup Testing**
- [ ] Makefile target validation script executed
- [ ] Backup orchestration tested
- [ ] Recovery tests completed (PostgreSQL, MySQL, Redis)
- [ ] Backup timing benchmarks recorded
- [ ] Issues documented: _____________

**Phase 4: Upgrade Testing**
- [ ] Pre-upgrade checks validated
- [ ] Post-upgrade validation tested
- [ ] Upgrade strategies reviewed
- [ ] Rollback tests completed
- [ ] Issues documented: _____________

**Phase 5: Integration Testing**
- [ ] Database integrations tested
- [ ] Redis integrations tested
- [ ] Object storage integrations tested
- [ ] Monitoring integrations tested
- [ ] Issues documented: _____________

**Phase 6: Final Validation**
- [ ] All test results reviewed
- [ ] Issue tickets created for post-release fixes
- [ ] Release notes drafted
- [ ] CHANGELOG.md updated
- [ ] Sign-off obtained

---

## Known Issues and Limitations

### Documentation
- No known issues at this time

### RBAC
- No known issues at this time

### Backup/Recovery
- **Note**: Backup targets are Makefile-driven, not automated CronJobs
- Recovery testing performed on dev/test environments only

### Upgrade
- **Note**: Some version-specific notes are based on upstream documentation, not tested
- Rollback testing performed on critical charts only (PostgreSQL, MySQL, Redis, Keycloak)

### Integration
- **Note**: Integration tests assume charts deployed in same namespace
- Cross-namespace integration not extensively tested

---

## Sign-Off

**Test Lead**: ____________________ Date: ____________________

**Documentation Review**: ____________________ Date: ____________________

**Technical Review**: ____________________ Date: ____________________

**Release Approval**: ____________________ Date: ____________________

---

**Created**: 2025-12-09
**Status**: Ready for execution
**Estimated Effort**: 10 days (comprehensive testing)
**Actual Effort**: TBD
